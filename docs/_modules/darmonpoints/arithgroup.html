<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.01.29 -->
        <title>darmonpoints.arithgroup - darmonpoints 7.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="https://doc.sagemath.org/html/en/reference/_static/custom-furo.css" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  --color-brand-primary: #0f0fff;
  --color-brand-content: #0f0fff;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">darmonpoints 7.0.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/logo.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../_static/logo.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">darmonpoints 7.0.0 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../arithmeticgroups.html">Arithmetic group elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arithmeticgroups.html#module-darmonpoints.arithgroup_nscartan">Non-split Cartan</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arithmeticgroups.html#module-darmonpoints.arithgroup">Arithmetic group</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arithmeticgroups.html#module-darmonpoints.sarithgroup">S-arithmetic group</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cohomology.html">Abstract cohomology class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cohomology.html#module-darmonpoints.cohomology_arithmetic">Arithmetic cohomology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cohomology.html#module-darmonpoints.homology_abstract">Abstract homology class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cohomology.html#module-darmonpoints.homology">Homology class</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../integration.html">Integrals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../integration.html#module-darmonpoints.limits">Limits</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../distributions.html">Overconvergent module of distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../distributions.html#module-darmonpoints.representations">Representations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../internals.html">Mixed extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internals.html#module-darmonpoints.util">Utility package</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for darmonpoints.arithgroup</h1><div class="highlight"><pre>
<span></span><span class="c1">######################</span>
<span class="c1">##                  ##</span>
<span class="c1">##    QUATERNIONIC  ##</span>
<span class="c1">##    ARITHMETIC    ##</span>
<span class="c1">##    GROUP         ##</span>
<span class="c1">##                  ##</span>
<span class="c1">######################</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">currentframe</span><span class="p">,</span> <span class="n">getfile</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">islice</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">starmap</span><span class="p">,</span> <span class="n">tee</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">dirname</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="kn">from</span> <span class="nn">sage.algebras.quatalg.all</span> <span class="kn">import</span> <span class="n">QuaternionAlgebra</span>
<span class="kn">from</span> <span class="nn">sage.arith.all</span> <span class="kn">import</span> <span class="n">lcm</span>
<span class="kn">from</span> <span class="nn">sage.functions.generalized</span> <span class="kn">import</span> <span class="n">sgn</span>
<span class="kn">from</span> <span class="nn">sage.functions.hyperbolic</span> <span class="kn">import</span> <span class="n">acosh</span>
<span class="kn">from</span> <span class="nn">sage.functions.trig</span> <span class="kn">import</span> <span class="n">arctan</span>
<span class="kn">from</span> <span class="nn">sage.geometry.hyperbolic_space.hyperbolic_geodesic</span> <span class="kn">import</span> <span class="n">HyperbolicGeodesicUHP</span>
<span class="kn">from</span> <span class="nn">sage.geometry.hyperbolic_space.hyperbolic_interface</span> <span class="kn">import</span> <span class="n">HyperbolicPlane</span>
<span class="kn">from</span> <span class="nn">sage.groups.free_group</span> <span class="kn">import</span> <span class="n">FreeGroup</span>
<span class="kn">from</span> <span class="nn">sage.groups.group</span> <span class="kn">import</span> <span class="n">AlgebraicGroup</span>
<span class="kn">from</span> <span class="nn">sage.matrix.all</span> <span class="kn">import</span> <span class="n">Matrix</span><span class="p">,</span> <span class="n">matrix</span>
<span class="kn">from</span> <span class="nn">sage.matrix.matrix_space</span> <span class="kn">import</span> <span class="n">MatrixSpace</span>
<span class="kn">from</span> <span class="nn">sage.misc.all</span> <span class="kn">import</span> <span class="n">cached_method</span><span class="p">,</span> <span class="n">walltime</span>
<span class="kn">from</span> <span class="nn">sage.misc.misc_c</span> <span class="kn">import</span> <span class="n">prod</span>
<span class="kn">from</span> <span class="nn">sage.misc.persist</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">sage.misc.sage_eval</span> <span class="kn">import</span> <span class="n">sage_eval</span>
<span class="kn">from</span> <span class="nn">sage.misc.verbose</span> <span class="kn">import</span> <span class="n">verbose</span>
<span class="kn">from</span> <span class="nn">sage.modular.arithgroup.congroup_sl2z</span> <span class="kn">import</span> <span class="n">SL2Z</span>
<span class="kn">from</span> <span class="nn">sage.modules.all</span> <span class="kn">import</span> <span class="n">vector</span>
<span class="kn">from</span> <span class="nn">sage.modules.fg_pid.fgp_module</span> <span class="kn">import</span> <span class="n">FGP_Module</span>
<span class="kn">from</span> <span class="nn">sage.modules.free_module</span> <span class="kn">import</span> <span class="n">FreeModule_generic</span>
<span class="kn">from</span> <span class="nn">sage.plot.hyperbolic_arc</span> <span class="kn">import</span> <span class="n">hyperbolic_arc</span>
<span class="kn">from</span> <span class="nn">sage.plot.hyperbolic_polygon</span> <span class="kn">import</span> <span class="n">hyperbolic_polygon</span><span class="p">,</span> <span class="n">hyperbolic_triangle</span>
<span class="kn">from</span> <span class="nn">sage.plot.plot</span> <span class="kn">import</span> <span class="n">plot</span>
<span class="kn">from</span> <span class="nn">sage.plot.point</span> <span class="kn">import</span> <span class="n">point2d</span>
<span class="kn">from</span> <span class="nn">sage.repl.rich_output.pretty_print</span> <span class="kn">import</span> <span class="n">show</span>
<span class="kn">from</span> <span class="nn">sage.rings.all</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AA</span><span class="p">,</span>
    <span class="n">QQ</span><span class="p">,</span>
    <span class="n">RR</span><span class="p">,</span>
    <span class="n">ZZ</span><span class="p">,</span>
    <span class="n">ComplexField</span><span class="p">,</span>
    <span class="n">NumberField</span><span class="p">,</span>
    <span class="n">PolynomialRing</span><span class="p">,</span>
    <span class="n">Qp</span><span class="p">,</span>
    <span class="n">QuadraticField</span><span class="p">,</span>
    <span class="n">RealField</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sage.rings.infinity</span> <span class="kn">import</span> <span class="n">Infinity</span>
<span class="kn">from</span> <span class="nn">sage.structure.element</span> <span class="kn">import</span> <span class="n">MultiplicativeGroupElement</span>
<span class="kn">from</span> <span class="nn">sage.structure.sage_object</span> <span class="kn">import</span> <span class="n">SageObject</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">save</span>

<span class="kn">from</span> <span class="nn">.arithgroup_generic</span> <span class="kn">import</span> <span class="n">ArithGroup_generic</span><span class="p">,</span> <span class="n">ArithGroup_matrix_generic</span>
<span class="kn">from</span> <span class="nn">.mixed_extension</span> <span class="kn">import</span> <span class="n">get_word_rep_fast</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="hyperbolic_distance">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.hyperbolic_distance">[docs]</a>
<span class="k">def</span> <span class="nf">hyperbolic_distance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">real</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">real</span><span class="p">(),</span> <span class="n">beta</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">acosh</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">y1</span> <span class="o">*</span> <span class="n">y2</span><span class="p">))</span></div>



<div class="viewcode-block" id="geodesic_circle">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.geodesic_circle">[docs]</a>
<span class="k">def</span> <span class="nf">geodesic_circle</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">return_equation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From a picture (pg 79) in &quot;Hyperbolic Geometry&quot;,</span>
<span class="sd">    in an article Cannon, Floyd, Kenyon, Parry</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">K</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_infinity</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="k">else</span> <span class="n">beta</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">is_infinity</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
        <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span><span class="p">,</span> <span class="n">alpha</span>
    <span class="k">if</span> <span class="n">is_infinity</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">real</span><span class="p">()</span> <span class="o">-</span> <span class="n">beta</span><span class="o">.</span><span class="n">real</span><span class="p">())</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">10</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;x,y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">alpha</span><span class="o">.</span><span class="n">real</span><span class="p">()</span> <span class="k">if</span> <span class="n">return_equation</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">real</span><span class="p">(),</span> <span class="n">Infinity</span><span class="p">)</span>

    <span class="n">z0</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
    <span class="n">t</span> <span class="o">=</span> <span class="o">-</span><span class="n">z0</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span> <span class="o">/</span> <span class="n">z1</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">z1</span> <span class="o">*</span> <span class="n">t</span>
    <span class="c1"># verbose(&#39;z0 = %s, z1 = %s, t = %s, C = %s&#39;%(z0, z1, t, C))</span>
    <span class="k">assert</span> <span class="n">C</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">10</span><span class="p">,</span> <span class="n">C</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">C</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">AttributError</span><span class="p">:</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">-</span> <span class="n">C</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;x,y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">C</span><span class="o">.</span><span class="n">real</span><span class="p">())</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r2</span> <span class="k">if</span> <span class="n">return_equation</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">real</span><span class="p">(),</span> <span class="n">r2</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="is_in_open_interval">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.is_in_open_interval">[docs]</a>
<span class="k">def</span> <span class="nf">is_in_open_interval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mi">10</span><span class="o">**-</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="n">Infinity</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">eps</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">a</span> <span class="o">+</span> <span class="n">eps</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">b</span> <span class="o">-</span> <span class="n">eps</span></div>



<div class="viewcode-block" id="perturb_point_on_arc">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.perturb_point_on_arc">[docs]</a>
<span class="k">def</span> <span class="nf">perturb_point_on_arc</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
    <span class="n">RR</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">RR</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">geodesic_circle</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">CC</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
    <span class="n">rnorm</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">CC</span><span class="p">(</span><span class="n">RR</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">()</span> <span class="o">+</span> <span class="n">rnorm</span><span class="p">),</span> <span class="n">RR</span><span class="p">((</span><span class="n">r2</span> <span class="o">-</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">()</span> <span class="o">+</span> <span class="n">rnorm</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()))</span>
    <span class="p">)</span>
    <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">CC</span><span class="p">(</span><span class="n">RR</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">()</span> <span class="o">-</span> <span class="n">rnorm</span><span class="p">),</span> <span class="n">RR</span><span class="p">((</span><span class="n">r2</span> <span class="o">-</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">()</span> <span class="o">-</span> <span class="n">rnorm</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()))</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ans</span></div>



<div class="viewcode-block" id="intersect_geodesic_arcs">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.intersect_geodesic_arcs">[docs]</a>
<span class="k">def</span> <span class="nf">intersect_geodesic_arcs</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TESTS::</span>

<span class="sd">    sage: from darmonpoints.arithgroup import intersect_geodesic_arcs</span>
<span class="sd">    sage: intersect_geodesic_arcs(1,3,2,4)</span>
<span class="sd">    1/2*I*sqrt(3) + 5/2</span>
<span class="sd">    sage: print(intersect_geodesic_arcs(-1, 1, 0, AA(-1).sqrt()))</span>
<span class="sd">    None</span>
<span class="sd">    sage: intersect_geodesic_arcs(-1, 1, 0, 2*AA(-1).sqrt())</span>
<span class="sd">    I</span>
<span class="sd">    sage: intersect_geodesic_arcs(-3, 3, 2*AA(-1).sqrt(), Infinity)</span>
<span class="sd">    3*I</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># verbose(&#39;Entering intersect_geodesic_arcs&#39;)</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">geodesic_circle</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">geodesic_circle</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e2</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># e2 is a line</span>
        <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e1</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span>
    <span class="k">if</span> <span class="n">e1</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># e1 is a line</span>
        <span class="k">if</span> <span class="n">e2</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Both are lines!</span>
            <span class="c1"># verbose(&#39;Done intersect_geodesic_arcs&#39;)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">e1</span><span class="o">.</span><span class="n">constant_coefficient</span><span class="p">()</span>  <span class="c1"># x-coordinate of intersection</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">e2</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
        <span class="n">y_squared</span> <span class="o">=</span> <span class="o">-</span><span class="n">e2</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span>
            <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">alpha</span><span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">constant_coefficient</span><span class="p">()</span>  <span class="c1"># y-coordinate of intersection, squared</span>
        <span class="k">if</span> <span class="n">y_squared</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># verbose(&#39;Done intersect_geodesic_arcs&#39;)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">y_squared</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_in_open_interval</span><span class="p">(</span>
                <span class="n">yy</span><span class="p">,</span> <span class="n">imag_part</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">imag_part</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="mi">0</span>
            <span class="p">)</span> <span class="ow">and</span> <span class="n">is_in_open_interval</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">real_part</span><span class="p">(</span><span class="n">y1</span><span class="p">),</span> <span class="n">real_part</span><span class="p">(</span><span class="n">y2</span><span class="p">),</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># verbose(&#39;Done intersect_geodesic_arcs&#39;)</span>
                <span class="k">return</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">yy</span> <span class="o">*</span> <span class="n">AA</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># verbose(&#39;Done intersect_geodesic_arcs&#39;)</span>
                <span class="k">return</span> <span class="kc">None</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">e1</span> <span class="o">-</span> <span class="n">e2</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="o">-</span><span class="n">e</span><span class="o">.</span><span class="n">constant_coefficient</span><span class="p">()</span> <span class="o">/</span> <span class="n">e</span><span class="o">.</span><span class="n">monomial_coefficient</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
    <span class="n">y_squared</span> <span class="o">=</span> <span class="o">-</span><span class="n">e1</span><span class="o">.</span><span class="n">subs</span><span class="p">({</span><span class="n">x</span><span class="p">:</span> <span class="n">xx</span><span class="p">})</span><span class="o">.</span><span class="n">constant_coefficient</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">y_squared</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># verbose(&#39;Done intersect_geodesic_arcs&#39;)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">is_in_open_interval</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">real_part</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">real_part</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_in_open_interval</span><span class="p">(</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">real_part</span><span class="p">(</span><span class="n">y1</span><span class="p">),</span> <span class="n">real_part</span><span class="p">(</span><span class="n">y2</span><span class="p">),</span> <span class="mi">0</span>
    <span class="p">):</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">y_squared</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="c1"># verbose(&#39;Done intersect_geodesic_arcs&#39;)</span>
        <span class="k">return</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">yy</span> <span class="o">*</span> <span class="n">AA</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># verbose(&#39;Done intersect_geodesic_arcs&#39;)</span>
        <span class="k">return</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="sorted_ideal_endpoints">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.sorted_ideal_endpoints">[docs]</a>
<span class="k">def</span> <span class="nf">sorted_ideal_endpoints</span><span class="p">(</span><span class="n">geodesic</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the ideal (boundary) endpoints of the complete</span>
<span class="sd">    hyperbolic geodesic corresponding to ``geodesic``.</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">    - a list of 2 boundary points</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">geodesic</span><span class="o">.</span><span class="n">_start</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">geodesic</span><span class="o">.</span><span class="n">_end</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span>
    <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">real_part</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]]</span>
    <span class="p">[</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">imag_part</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">geodesic</span><span class="o">.</span><span class="n">_model</span>
    <span class="c1"># infinity is the first endpoint, so the other ideal endpoint</span>
    <span class="c1"># is just the real part of the second coordinate</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">Infinity</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">x2</span><span class="p">)]</span>
    <span class="c1"># Same idea as above</span>
    <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="n">Infinity</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">end</span><span class="p">)]</span>
    <span class="c1"># We could also have a vertical line with two interior points</span>
    <span class="k">if</span> <span class="n">x1</span> <span class="o">==</span> <span class="n">x2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y1</span> <span class="o">&lt;</span> <span class="n">y2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">Infinity</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">Infinity</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">x1</span><span class="p">)]</span>
    <span class="c1"># Otherwise, we have a semicircular arc in the UHP</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">((</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">y1</span> <span class="o">+</span> <span class="n">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">c</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">r</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">r</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span> <span class="n">M</span><span class="o">.</span><span class="n">get_point</span><span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">r</span><span class="p">)]</span></div>



<div class="viewcode-block" id="moebius_transform">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.moebius_transform">[docs]</a>
<span class="k">def</span> <span class="nf">moebius_transform</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a matrix ``A`` in `GL(2, \CC)` and a point ``z`` in the complex</span>
<span class="sd">    plane return the Moebius transformation action of ``A`` on ``z``.</span>

<span class="sd">    INPUT:</span>

<span class="sd">    - ``A`` -- a `2 \times 2` invertible matrix over the complex numbers</span>
<span class="sd">    - ``z`` -- a complex number or infinity</span>

<span class="sd">    OUTPUT:</span>

<span class="sd">    - a complex number or infinity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">ncols</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">A</span><span class="o">.</span><span class="n">nrows</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">A</span><span class="o">.</span><span class="n">det</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="n">Infinity</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Infinity</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">c</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">*</span> <span class="n">d</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span>  <span class="c1"># Reverses orientation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">z</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Infinity</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
        <span class="s2">&quot;A must be an invertible 2x2 matrix over the&quot;</span>
        <span class="s2">&quot; complex numbers or a symbolic ring&quot;</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="angle_sign">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.angle_sign">[docs]</a>
<span class="k">def</span> <span class="nf">angle_sign</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>  <span class="c1"># UHP</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the angle between any two given completed geodesics if</span>
<span class="sd">    they intersect.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sorted_ideal_endpoints</span><span class="p">(</span><span class="n">left</span><span class="p">))</span>
    <span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">coordinates</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sorted_ideal_endpoints</span><span class="p">(</span><span class="n">right</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">p1</span> <span class="o">!=</span> <span class="n">Infinity</span> <span class="ow">and</span> <span class="n">p2</span> <span class="o">!=</span> <span class="n">Infinity</span><span class="p">:</span>  <span class="c1"># geodesic not a straight line</span>
        <span class="c1"># So we send it to the geodesic with endpoints [0, oo]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">HyperbolicGeodesicUHP</span><span class="o">.</span><span class="n">_crossratio_matrix</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># geodesic is a straight line, so we send it to the geodesic</span>
        <span class="c1"># with endpoints [0,oo]</span>
        <span class="k">if</span> <span class="n">p1</span> <span class="o">==</span> <span class="n">Infinity</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">HyperbolicGeodesicUHP</span><span class="o">.</span><span class="n">_crossratio_matrix</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">HyperbolicGeodesicUHP</span><span class="o">.</span><span class="n">_crossratio_matrix</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="c1"># b1 and b2 are the endpoints of the image of right</span>
    <span class="k">if</span> <span class="n">T</span><span class="o">.</span><span class="n">determinant</span><span class="p">()</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">q1</span><span class="p">,</span> <span class="n">q2</span> <span class="o">=</span> <span class="n">q2</span><span class="p">,</span> <span class="n">q1</span>
    <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="n">moebius_transform</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">])</span>
    <span class="c1"># If right is now a straight line...</span>
    <span class="k">if</span> <span class="n">b1</span> <span class="o">==</span> <span class="n">Infinity</span> <span class="ow">or</span> <span class="n">b2</span> <span class="o">==</span> <span class="n">Infinity</span><span class="p">:</span>
        <span class="c1"># then since they intersect, they are equal</span>
        <span class="k">return</span> <span class="n">ZZ</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">b1</span> <span class="o">*</span> <span class="n">b2</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">b1</span><span class="o">.</span><span class="n">sign</span><span class="p">())</span></div>



<div class="viewcode-block" id="ArithGroup_fuchsian_generic">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic">[docs]</a>
<span class="k">class</span> <span class="nc">ArithGroup_fuchsian_generic</span><span class="p">(</span><span class="n">ArithGroup_generic</span><span class="p">):</span>
<div class="viewcode-block" id="ArithGroup_fuchsian_generic.get_embgquats_twisted">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.get_embgquats_twisted">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">get_embgquats_twisted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">CC</span> <span class="o">=</span> <span class="n">ComplexField</span><span class="p">(</span><span class="mi">800</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">CC</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span> <span class="o">/</span> <span class="n">CC</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">embgquats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embgquats</span>
        <span class="n">Pconj</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">([[</span><span class="n">Pconj</span><span class="p">,</span> <span class="o">-</span><span class="n">P</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">madj</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">adjugate</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">((</span><span class="n">madj</span> <span class="o">*</span> <span class="n">o</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">())</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">embgquats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.get_word_rep">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.get_word_rep">[docs]</a>
    <span class="k">def</span> <span class="nf">get_word_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># fuchsian generic</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">get_word_rep_fast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>  <span class="c1"># DEBUG</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Press C-c again to really interrupt...&quot;</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">delta0</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">parent</span><span class="p">()(</span><span class="n">delta</span><span class="p">)</span>
        <span class="n">ngquats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngquats</span>
        <span class="n">embgammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embgquats</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span>
        <span class="n">fdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdargs</span>
        <span class="n">findex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findex</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_order</span><span class="p">(</span><span class="n">delta</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;delta (= </span><span class="si">%s</span><span class="s2">) is not in order!&quot;</span> <span class="o">%</span> <span class="n">delta</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="n">ComplexField</span><span class="p">(</span><span class="mi">800</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">CC</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span> <span class="o">/</span> <span class="n">CC</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_archimedean_embedding</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">pi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">oldji</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">act_flt_in_disc</span><span class="p">(</span><span class="n">emb</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="n">CC</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">P</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">delta</span><span class="o">.</span><span class="n">is_one</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">is_one</span><span class="p">():</span>
            <span class="n">az0</span> <span class="o">=</span> <span class="n">CC</span><span class="p">(</span><span class="n">z0</span><span class="p">)</span><span class="o">.</span><span class="n">argument</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">az0</span> <span class="o">&lt;</span> <span class="n">fdargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">az0</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span>
            <span class="k">if</span> <span class="n">az0</span> <span class="o">&gt;</span> <span class="n">fdargs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">ji</span> <span class="o">=</span> <span class="n">findex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">embgg</span> <span class="o">=</span> <span class="n">embgammas</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">act_flt_in_disc</span><span class="p">(</span><span class="n">embgg</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">z0</span><span class="o">.</span><span class="n">abs</span><span class="p">():</span>
                    <span class="n">ji</span> <span class="o">=</span> <span class="n">findex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">fda</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fdargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">az0</span> <span class="o">&lt;</span> <span class="n">fda</span><span class="p">))</span>
                <span class="n">ji</span> <span class="o">=</span> <span class="n">findex</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">embgg</span> <span class="o">=</span> <span class="n">embgammas</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">gammas</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span>

            <span class="n">z0</span> <span class="o">=</span> <span class="n">act_flt_in_disc</span><span class="p">(</span><span class="n">embgg</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">gg</span> <span class="o">*</span> <span class="n">delta</span>
            <span class="k">if</span> <span class="n">ji</span> <span class="o">==</span> <span class="o">-</span><span class="n">oldji</span><span class="p">:</span>  <span class="c1"># had a choice, need to pick the other</span>
                <span class="n">z0abs</span> <span class="o">=</span> <span class="n">z0</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
                <span class="n">ji</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">j</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">ngquats</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ngquats</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="n">oldji</span>
                        <span class="ow">and</span> <span class="n">act_flt_in_disc</span><span class="p">(</span><span class="n">embgammas</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">z0</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">z0abs</span>
                    <span class="p">),</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">gg</span> <span class="o">=</span> <span class="n">gammas</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span>
            <span class="n">oldji</span> <span class="o">=</span> <span class="n">ji</span>
            <span class="n">ans</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="n">ji</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;P&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span><span class="p">:</span>
            <span class="n">delta1</span> <span class="o">=</span> <span class="n">multiply_out</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">delta1</span> <span class="o">!=</span> <span class="n">delta</span><span class="p">:</span>
                <span class="n">ans</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minus_one_long</span><span class="p">)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">reduce_word_tietze</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ans</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.magma_word_problem">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.magma_word_problem">[docs]</a>
    <span class="k">def</span> <span class="nf">magma_word_problem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Gm</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a quaternion x, finds its decomposition in terms of the generators</span>

<span class="sd">        INPUT: x can be a list/vector of integers (giving the quaternion in terms of the basis for the order,</span>
<span class="sd">        or x can be a quaternion, in which case the conversion is done in the function.</span>

<span class="sd">        OUTPUT: A list representing a word in the generators</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span>
        <span class="c1"># If x is a quaternion, find the expression in the generators.</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">:</span>  <span class="c1"># .parent() is self.O or x.parent() is self.B:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">quaternion_to_magma_quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x (=</span><span class="si">%s</span><span class="s2">) should be a list of length 4&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">quaternion_to_magma_quaternion</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_O_basis</span><span class="p">(),</span> <span class="n">x</span><span class="p">))),</span>
            <span class="p">)</span>
        <span class="n">x_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">WordProblem</span><span class="p">(</span><span class="n">x_magma</span><span class="p">)</span><span class="o">.</span><span class="n">ElementToSequence</span><span class="p">()</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span>
        <span class="n">delta1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">V</span><span class="p">:</span>
            <span class="n">delta1</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">delta1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">[</span><span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">delta1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">[</span><span class="o">-</span><span class="n">v</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">delta1</span> <span class="o">!=</span> <span class="n">x0</span> <span class="ow">and</span> <span class="s2">&quot;P&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span><span class="p">:</span>
            <span class="n">V</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minus_one_long</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">V</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.draw_mat_list">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.draw_mat_list">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_mat_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="n">mlist</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_archimedean_embedding</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">hyperbolic_arc</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">act_flt</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">g1</span><span class="o">.</span><span class="n">quaternion_rep</span><span class="p">),</span> <span class="n">x0</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
        <span class="n">vlist</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">_fundamental_domain</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">mlist</span><span class="p">:</span>
            <span class="n">new_polygon</span> <span class="o">=</span> <span class="p">[</span><span class="n">act_flt</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">g</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vlist</span><span class="p">]</span>
            <span class="n">P</span> <span class="o">+=</span> <span class="n">hyperbolic_polygon</span><span class="p">(</span><span class="n">new_polygon</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.mat_list">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.mat_list">[docs]</a>
    <span class="k">def</span> <span class="nf">mat_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">check_fundom</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># generic</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list S of matrices such that the geodesic (x1, x2) is contained in the union</span>
<span class="sd">        of the translates s*D (with s in S) of the standard fundamental domain D.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Calling mat_list with x1 = </span><span class="si">%s</span><span class="s2"> and x2 = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
        <span class="n">x1_orig</span> <span class="o">=</span> <span class="n">x1</span>
        <span class="n">x2_orig</span> <span class="o">=</span> <span class="n">x2</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">g</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">check_fundom</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">x1</span><span class="p">):</span>
            <span class="n">t0</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_fundom_rep</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="p">(</span><span class="n">g</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x2</span>

        <span class="c1"># Here we can assume that x1 is in the fundamental domain</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">x2</span><span class="p">):</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">intersection_candidates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain_data</span><span class="p">()):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">intersect_geodesic_arcs</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># We take a perturbation of z to avoid boundary problems</span>
                    <span class="n">eps</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">4</span>
                    <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">perturb_point_on_arc</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">z1</span><span class="p">):</span>
                        <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="p">,</span> <span class="n">z1</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span>
                            <span class="n">z1</span>
                        <span class="p">),</span> <span class="s2">&quot;z1 and z2 are both outside of fundom!&quot;</span>
                        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span>
                            <span class="n">z2</span>
                        <span class="p">),</span> <span class="s2">&quot;z1 and z2 are both inside of fundom!&quot;</span>
                        <span class="n">intersection_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection_candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;No intersection candidates!!&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection_candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">verbose</span><span class="p">(</span><span class="n">intersection_candidates</span><span class="p">)</span>
            <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">intersection_candidates</span><span class="p">[</span>
                <span class="n">ZZ</span><span class="o">.</span><span class="n">random_element</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intersection_candidates</span><span class="p">))</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">z2</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">t0</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="ow">not</span> <span class="n">found</span><span class="p">,</span> <span class="s2">&quot;Found more than one!&quot;</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">t0</span>
                    <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x2</span>
                    <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;x1 = </span><span class="si">%s</span><span class="s2">, x2 = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
                    <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
                    <span class="k">break</span>  <span class="c1"># DEBUG</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;WARNING!!!! Did not find any to move. Continuing anyway...&quot;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">quaternion_rep</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ans</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">_fix_sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">signature</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">signature</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">signature</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># raise NotImplementedError</span>
            <span class="k">return</span> <span class="n">x</span>  <span class="c1"># FIXME this may not be correct</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">embeddings</span><span class="p">(</span><span class="n">RealField</span><span class="p">(</span><span class="mi">800</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">emb</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">())</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span> <span class="o">!=</span> <span class="n">emb</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_positive_unit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">emb</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">())</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span> <span class="o">!=</span> <span class="n">emb</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error in fix_sign&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<div class="viewcode-block" id="ArithGroup_fuchsian_generic.find_fundom_rep">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.find_fundom_rep">[docs]</a>
    <span class="k">def</span> <span class="nf">find_fundom_rep</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">z0_H</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_alternative</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_iters</span><span class="o">=</span><span class="mi">100</span>
    <span class="p">):</span>  <span class="c1"># generic -- Take z0 to the fundamental domain</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns t0 and g such that g * t0 = z0_H, and t0 is in the fundamental domain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="n">z0_H</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">z0_H</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;z0_H must be in the upper half plane&quot;</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Moving z0_H = </span><span class="si">%s</span><span class="s2"> to fundamental domain&quot;</span> <span class="o">%</span> <span class="n">z0_H</span><span class="p">)</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_archimedean_embedding</span><span class="p">(</span><span class="n">CC</span><span class="o">.</span><span class="n">precision</span><span class="p">())</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">CC</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span> <span class="o">/</span> <span class="n">CC</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">CC</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">Pconj</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">conjugate</span><span class="p">()</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="p">(</span><span class="n">z0_H</span> <span class="o">-</span> <span class="n">P</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">z0_H</span> <span class="o">-</span> <span class="n">Pconj</span><span class="p">)</span>
        <span class="n">ngquats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngquats</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span>
        <span class="n">embgammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embgquats</span>
        <span class="n">findex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findex</span>
        <span class="n">fdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdargs</span>
        <span class="n">wd</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">oldji</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">oldgg</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="n">gg</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="n">embgg</span> <span class="o">=</span> <span class="n">embgammas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">0</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="n">n_iters</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">z0_H</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">z0_H</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">t1</span><span class="p">):</span>
            <span class="n">n_iters</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">n_iters</span> <span class="o">&gt;=</span> <span class="n">max_iters</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Reached maximum number of iterations (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">max_iters</span>
                <span class="p">)</span>
            <span class="n">az0</span> <span class="o">=</span> <span class="n">CC</span><span class="p">(</span><span class="n">z0</span><span class="p">)</span><span class="o">.</span><span class="n">argument</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">az0</span> <span class="o">&lt;</span> <span class="n">fdargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">az0</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi</span>
            <span class="k">if</span> <span class="n">az0</span> <span class="o">&gt;</span> <span class="n">fdargs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">ji</span> <span class="o">=</span> <span class="n">findex</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">embgg</span> <span class="o">=</span> <span class="n">embgammas</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">act_flt_in_disc</span><span class="p">(</span><span class="n">embgg</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">z0</span><span class="o">.</span><span class="n">abs</span><span class="p">():</span>
                    <span class="n">ji</span> <span class="o">=</span> <span class="n">findex</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">embgg</span> <span class="o">=</span> <span class="n">embgammas</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">fda</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fdargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">az0</span> <span class="o">&lt;=</span> <span class="n">fda</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">ji</span> <span class="o">=</span> <span class="n">findex</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">embgg</span> <span class="o">=</span> <span class="n">embgammas</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">ji</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ji</span> <span class="o">==</span> <span class="o">-</span><span class="n">oldji</span><span class="p">:</span>
                <span class="n">my_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">ngquats</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ngquats</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">ji</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">j</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">my_range</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="n">oldji</span>
                        <span class="ow">and</span> <span class="n">act_flt_in_disc</span><span class="p">(</span><span class="n">embgammas</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">z0</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">z0</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
                    <span class="p">),</span>
                    <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">ji</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">gammas</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span> <span class="o">*</span> <span class="n">oldgg</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">embgg</span> <span class="o">=</span> <span class="n">embgammas</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span>
            <span class="n">gg</span> <span class="o">=</span> <span class="n">gammas</span><span class="p">[</span><span class="n">ji</span><span class="p">]</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">gg</span> <span class="o">*</span> <span class="n">delta</span>
            <span class="n">z0</span> <span class="o">=</span> <span class="n">act_flt_in_disc</span><span class="p">(</span><span class="n">embgg</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
            <span class="n">oldji</span><span class="p">,</span> <span class="n">oldgg</span> <span class="o">=</span> <span class="n">ji</span><span class="p">,</span> <span class="n">gg</span>
            <span class="n">wd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gg</span><span class="p">)</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;New g = </span><span class="si">%s</span><span class="se">\t</span><span class="s2"> delta = </span><span class="si">%s</span><span class="se">\t</span><span class="s2"> z0=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gg</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">z0</span><span class="p">))</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">*</span> <span class="n">z0_H</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">wd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">delta</span><span class="p">)</span> <span class="o">*</span> <span class="n">z0_H</span>
        <span class="n">delta_inv</span> <span class="o">=</span> <span class="n">delta</span><span class="o">**-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">return_alternative</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">delta_inv</span><span class="p">),</span> <span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">delta_inv</span> <span class="o">*</span> <span class="n">wd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">t0</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom_boundary</span><span class="p">(</span><span class="n">t0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">t0</span><span class="p">,</span> <span class="n">delta_inv</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom_boundary</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">delta_inv</span> <span class="o">*</span> <span class="n">wd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.plot_fundamental_domain">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.plot_fundamental_domain">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_fundamental_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hyperbolic_polygon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain</span><span class="p">())</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.fundamental_domain_interior_data">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.fundamental_domain_interior_data">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">fundamental_domain_interior_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># generic</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">CC</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">90.0</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>  <span class="c1"># A point inside the fundamental domain.</span>
        <span class="n">in_interior</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain_data</span><span class="p">():</span>
            <span class="n">center</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">geodesic_circle</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">in_interior</span><span class="p">[(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">center</span><span class="p">,</span>
                <span class="n">r2</span><span class="p">,</span>
                <span class="p">((</span><span class="n">P</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="p">),</span>
            <span class="p">)</span>  <span class="c1"># The last argument encodes whether one needs to take the exterior or the interior of the geodesic circle.</span>
        <span class="k">return</span> <span class="n">in_interior</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.fundamental_domain">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.fundamental_domain">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">fundamental_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fundamental_domain</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.fundamental_domain_data">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.fundamental_domain_data">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">fundamental_domain_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fdom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain</span><span class="p">()</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fdom</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fdom</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fdom</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fdom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fdom</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">ans</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.is_in_fundom">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.is_in_fundom">[docs]</a>
    <span class="k">def</span> <span class="nf">is_in_fundom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">in_interior_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain_interior_data</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain_data</span><span class="p">():</span>
            <span class="n">center</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">in_interior</span> <span class="o">=</span> <span class="n">in_interior_data</span><span class="p">[(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)]</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">z</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">r2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">in_interior</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.is_in_fundom_interior">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.is_in_fundom_interior">[docs]</a>
    <span class="k">def</span> <span class="nf">is_in_fundom_interior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">in_interior_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain_interior_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">5</span>
        <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain_data</span><span class="p">():</span>
            <span class="n">center</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">in_interior</span> <span class="o">=</span> <span class="n">in_interior_data</span><span class="p">[(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">in_interior</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r2</span> <span class="o">-</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">z</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">-</span> <span class="n">r2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.is_in_fundom_exterior">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.is_in_fundom_exterior">[docs]</a>
    <span class="k">def</span> <span class="nf">is_in_fundom_exterior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom_interior</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom_boundary</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.is_in_fundom_boundary">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.is_in_fundom_boundary">[docs]</a>
    <span class="k">def</span> <span class="nf">is_in_fundom_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">in_interior_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain_interior_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">5</span>
        <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain_data</span><span class="p">():</span>
            <span class="n">center</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">in_interior</span> <span class="o">=</span> <span class="n">in_interior_data</span><span class="p">[(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">r2</span> <span class="o">-</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">())</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_in_open_interval</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span><span class="p">(),</span> <span class="n">v1</span><span class="o">.</span><span class="n">real</span><span class="p">(),</span> <span class="n">v2</span><span class="o">.</span><span class="n">real</span><span class="p">(),</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ArithGroup_fuchsian_generic.get_archimedean_embedding">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_fuchsian_generic.get_archimedean_embedding">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">get_archimedean_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prec</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an embedding of the quaternion algebra</span>
<span class="sd">        into the algebra of 2x2 matrices with coefficients in `RR`.</span>

<span class="sd">        INPUT:</span>

<span class="sd">        - prec -- Integer. The precision of the splitting.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitting_at_infinity</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_into_RR</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">*</span> <span class="n">m</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">coefficient_tuple</span><span class="p">(),</span> <span class="n">mats</span><span class="p">))</span></div>


    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">_splitting_at_infinity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prec</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds an embedding of the quaternion algebra</span>
<span class="sd">        into the algebra of 2x2 matrices with coefficients in `\RR`.</span>

<span class="sd">        INPUT:</span>

<span class="sd">        - prec -- Integer. The precision of the splitting.</span>

<span class="sd">        OUTPUT:</span>

<span class="sd">        - Matrices I, J, K giving the splitting.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prec</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prec_inf</span><span class="p">:</span>
            <span class="n">wtime</span> <span class="o">=</span> <span class="n">walltime</span><span class="p">()</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Calling MatrixRing...&quot;</span><span class="p">)</span>
            <span class="n">B_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">FuchsianMatrixRepresentation</span><span class="p">(</span>
                <span class="n">B_magma</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">Precision</span><span class="o">=</span><span class="n">prec</span><span class="p">,</span> <span class="n">nvals</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Spent </span><span class="si">%s</span><span class="s2"> seconds in MatrixRing&quot;</span> <span class="o">%</span> <span class="n">walltime</span><span class="p">(</span><span class="n">wtime</span><span class="p">))</span>
            <span class="n">RR</span> <span class="o">=</span> <span class="n">RealField</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prec_inf</span> <span class="o">=</span> <span class="n">prec</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_II_inf</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">RR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_JJ_inf</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">RR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_KK_inf</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">RR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_11_inf</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">RR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">RR</span> <span class="o">=</span> <span class="n">RealField</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
            <span class="n">rimg</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                <span class="n">B_magma</span><span class="p">(</span><span class="n">sage_F_elt_to_magma</span><span class="p">(</span><span class="n">B_magma</span><span class="o">.</span><span class="n">BaseRing</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">gen</span><span class="p">()))</span>
            <span class="p">)</span><span class="o">.</span><span class="n">Vector</span><span class="p">()</span>
            <span class="n">rimg_matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">RR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">rimg</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)])</span>
            <span class="k">assert</span> <span class="n">rimg_matrix</span><span class="o">.</span><span class="n">is_scalar</span><span class="p">()</span>
            <span class="n">rimg</span> <span class="o">=</span> <span class="n">rimg_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rimg</span> <span class="o">=</span> <span class="n">rimg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F_into_RR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">hom</span><span class="p">([</span><span class="n">rimg</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_11_inf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_II_inf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_JJ_inf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_KK_inf</span></div>



<div class="viewcode-block" id="ArithGroup_rationalquaternion">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalquaternion">[docs]</a>
<span class="k">class</span> <span class="nc">ArithGroup_rationalquaternion</span><span class="p">(</span><span class="n">ArithGroup_fuchsian_generic</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">discriminant</span><span class="p">,</span>
        <span class="n">level</span><span class="p">,</span>
        <span class="n">info_magma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">grouptype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">magma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_presentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="n">grouptype</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;SL2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PSL2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PGL2&quot;</span><span class="p">,</span>
        <span class="p">]</span>  <span class="c1"># Need to find how to return the other groups with Voight&#39;s algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span> <span class="o">=</span> <span class="n">grouptype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_presentation</span> <span class="o">=</span> <span class="n">compute_presentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magma</span> <span class="o">=</span> <span class="n">magma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">QQ</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">discriminant</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">discriminant</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abtuple</span> <span class="o">=</span> <span class="n">discriminant</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discriminant</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span>
                <span class="n">QuaternionAlgebra</span><span class="p">(</span><span class="n">discriminant</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">discriminant</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">discriminant</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">discriminant</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">discriminant</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prec_inf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">O_magma</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;O_magma&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_magma_objects</span><span class="p">(</span><span class="n">info_magma</span><span class="p">,</span> <span class="n">O_magma</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">QuaternionAlgebra</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">_sage_</span><span class="p">(),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">discriminant</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">discriminant</span>
        <span class="p">),</span> <span class="s2">&quot;Error while constructing quaternion algebra&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">O</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">quaternion_order</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">QQ</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span><span class="o">.</span><span class="n">ZBasis</span><span class="p">()[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Vector</span><span class="p">()[</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_presentation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_geometric_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;Arithmetic Group attached to rational quaternion algebra, disc = </span><span class="si">%s</span><span class="s2">, level = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discriminant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_geometric_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># rationalquaternion</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">RealField</span><span class="p">(</span><span class="mi">800</span><span class="p">)(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arctan</span><span class="p">()</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_archimedean_embedding</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;_ratquat_</span><span class="si">{quatalg}</span><span class="s2">_</span><span class="si">{levelnorm}</span><span class="s2">_</span><span class="si">{grouptype}</span><span class="s2">_</span><span class="si">{code}</span><span class="s2">.sobj&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">quatalg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">discriminant</span><span class="p">,</span>
                <span class="n">code</span><span class="o">=</span><span class="n">ZZ</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span>
                <span class="n">levelnorm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
                <span class="n">grouptype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">sage.misc.persist</span> <span class="kn">import</span> <span class="n">load</span>

                <span class="n">geom_dict</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ky</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">geom_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">embgquats</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">emb</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gens</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">element_class</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">quaternion_rep</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">word_rep</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Initialized fundamental domain data from file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initialized fundamental domain data from file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Will save fundamental domain data to file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initialized fundamental domain data from file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">pass</span>

        <span class="n">Gm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">FuchsianGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="n">FDom_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="o">.</span><span class="n">FundamentalDomain</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fundamental_domain</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ComplexField</span><span class="p">(</span><span class="mi">1000</span><span class="p">)(</span><span class="n">o</span><span class="o">.</span><span class="n">Real</span><span class="p">()</span><span class="o">.</span><span class="n">sage</span><span class="p">(),</span> <span class="n">o</span><span class="o">.</span><span class="n">Imaginary</span><span class="p">()</span><span class="o">.</span><span class="n">sage</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">FDom_magma</span>
        <span class="p">]</span>
        <span class="n">Um</span><span class="p">,</span> <span class="n">m1_magma</span><span class="p">,</span> <span class="n">m2_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">nvals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">magma_quaternion_to_sage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">(</span><span class="n">m2_magma</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">Um</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Um</span><span class="o">.</span><span class="n">gens</span><span class="p">()))</span>
        <span class="p">]</span>

        <span class="n">Uside_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="o">.</span><span class="n">get_magma_attribute</span><span class="p">(</span><span class="s2">&quot;ShimGroupSidepairs&quot;</span><span class="p">)</span>
        <span class="n">mside_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="o">.</span><span class="n">get_magma_attribute</span><span class="p">(</span><span class="s2">&quot;ShimGroupSidepairsMap&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Uside</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">magma_quaternion_to_sage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">(</span><span class="n">m2_magma</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">mside_magma</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">g</span><span class="p">))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">Uside_magma</span><span class="o">.</span><span class="n">Generators</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_unit_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span>

        <span class="c1"># We initialize some attributes by calling this function stupidly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">WordProblem</span><span class="p">(</span><span class="n">Gm</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">gquats_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="o">.</span><span class="n">get_magma_attribute</span><span class="p">(</span><span class="s2">&quot;ShimGroupSidepairsQuats&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngquats</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gquats_magma</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;len(gquats) = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngquats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span> <span class="o">=</span> <span class="n">translate_into_twosided_list</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">magma_quaternion_to_sage</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">(</span><span class="n">gquats_magma</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">()),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gquats_magma</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embgquats</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">emb</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">findex</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ZZ</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">_sage_</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Gm</span><span class="o">.</span><span class="n">get_magma_attribute</span><span class="p">(</span><span class="s2">&quot;ShimGroupSidepairsIndex&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdargs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">RealField</span><span class="p">(</span><span class="mi">800</span><span class="p">)(</span><span class="n">x</span><span class="o">.</span><span class="n">_sage_</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Gm</span><span class="o">.</span><span class="n">get_magma_attribute</span><span class="p">(</span><span class="s2">&quot;ShimFDArgs&quot;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minus_one_long</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magma_word_problem</span><span class="p">(</span><span class="n">Gm</span><span class="p">,</span> <span class="n">g</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate_inv</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="p">[</span><span class="o">-</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">trans</span><span class="p">)]</span> <span class="k">for</span> <span class="n">trans</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quaternion_rep</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">word_rep</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">temp_relation_words</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Um</span><span class="o">.</span><span class="n">Relations</span><span class="p">()[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LHS</span><span class="p">()</span><span class="o">.</span><span class="n">ElementToSequence</span><span class="p">()</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Um</span><span class="o">.</span><span class="n">Relations</span><span class="p">()))</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">temp_relation_words</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="n">multiply_out</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="s2">&quot;P&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newrel</span> <span class="o">=</span> <span class="n">rel</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus_one_long</span>
                <span class="k">assert</span> <span class="n">multiply_out</span><span class="p">(</span><span class="n">newrel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newrel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;O&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">O</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_II_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_II_inf</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_JJ_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_JJ_inf</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_KK_inf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_KK_inf</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_fundamental_domain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fundamental_domain</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;Ugens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;Uside&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Uside</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;F_unit_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_unit_offset</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;ngquats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngquats</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;gquats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;findex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findex</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;fdargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdargs</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;minus_one_long&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus_one_long</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;translate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_relation_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span>
            <span class="kn">from</span> <span class="nn">sage.misc.persist</span> <span class="kn">import</span> <span class="n">save</span>

            <span class="n">save</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Saved to file&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_magma_objects</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">info_magma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">O_magma</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>  <span class="c1"># Rational quaternions</span>
        <span class="n">wtime</span> <span class="o">=</span> <span class="n">walltime</span><span class="p">()</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Calling _init_magma_objects...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info_magma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">QQ_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">RationalsAsNumberField</span><span class="p">()</span>
            <span class="n">ZZ_magma</span> <span class="o">=</span> <span class="n">QQ_magma</span><span class="o">.</span><span class="n">MaximalOrder</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;abtuple&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">QuaternionAlgebra</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">QQ_magma</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">abtuple</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">abtuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">QuaternionAlgebra</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">*</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">discriminant</span><span class="p">,</span> <span class="n">ZZ_magma</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">MaximalOrder</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">O_magma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">ZZ</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">*</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">ZZ_magma</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Order</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">O_magma</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_D_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">UnitDisc</span><span class="p">(</span><span class="n">Precision</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ZZ_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">BaseRing</span><span class="p">()</span><span class="o">.</span><span class="n">Integers</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_B_magma</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_Omax_magma</span>
            <span class="k">if</span> <span class="n">O_magma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="n">ZZ</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_O_magma</span><span class="o">.</span><span class="n">pMaximalOrder</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">*</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ZZ</span><span class="p">(</span><span class="n">info_magma</span><span class="o">.</span><span class="n">level</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">),</span> <span class="n">ZZ_magma</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Order</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">O_magma</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_presentation</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_D_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">UnitDisc</span><span class="p">(</span><span class="n">Precision</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_D_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_D_magma</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">BaseRing</span><span class="p">()</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Spent </span><span class="si">%s</span><span class="s2"> seconds in init_magma_objects&quot;</span> <span class="o">%</span> <span class="n">walltime</span><span class="p">(</span><span class="n">wtime</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_quaternion_to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_basis_invmat</span><span class="p">()</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">coefficient_tuple</span><span class="p">())</span>
        <span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>

    <span class="c1"># rationalquaternion</span>
<div class="viewcode-block" id="ArithGroup_rationalquaternion.compute_quadratic_embedding">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalquaternion.compute_quadratic_embedding">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_quadratic_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">QQmagma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Rationals</span><span class="p">()</span>
        <span class="n">ZZmagma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Integers</span><span class="p">()</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">invariants</span><span class="p">()</span>
        <span class="n">Btmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">QuaternionAlgebra</span><span class="p">(</span><span class="n">QQmagma</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">quat_to_mquat</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Btmp</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">Btmp</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

        <span class="n">O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">QuaternionOrder</span><span class="p">(</span>
            <span class="n">ZZmagma</span><span class="p">,</span> <span class="p">[</span><span class="n">quat_to_mquat</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_O_basis</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="n">K_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">RadicalExtension</span><span class="p">(</span><span class="n">QQmagma</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="n">OK_magma</span> <span class="o">=</span> <span class="n">K_magma</span><span class="o">.</span><span class="n">MaximalOrder</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">iota</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Embed</span><span class="p">(</span><span class="n">OK_magma</span><span class="p">,</span> <span class="n">O_magma</span><span class="p">,</span> <span class="n">nvals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mu_magma</span> <span class="o">=</span> <span class="n">iota</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">OK_magma</span><span class="p">(</span><span class="n">K_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">Bgens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">gens</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">magma_quaternion_to_sage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">Btmp</span><span class="p">(</span><span class="n">mu_magma</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="p">)</span></div>


    <span class="c1"># rationalquaternion</span>
<div class="viewcode-block" id="ArithGroup_rationalquaternion.embed_order">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalquaternion.embed_order">[docs]</a>
    <span class="k">def</span> <span class="nf">embed_order</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_conductor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sage: from darmonpoints.sarithgroup import ArithGroup</span>
<span class="sd">        sage: G = ArithGroup(QQ,6,magma=Magma()) # optional - magma</span>
<span class="sd">        sage: f = G.embed_order(23,20) # optional - magma</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;quadratic_embedding&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_quadratic_embedding</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_ring</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">-</span> <span class="n">D</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">maximal_order</span><span class="p">()</span><span class="o">.</span><span class="n">ring_generators</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;w is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">w</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;w.minpoly() = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">())</span>
        <span class="n">QQp</span> <span class="o">=</span> <span class="n">Qp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
        <span class="n">w_minpoly</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">()</span><span class="o">.</span><span class="n">change_ring</span><span class="p">(</span><span class="n">QQp</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">coordinates_in_terms_of_powers</span><span class="p">()</span>
        <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">coords</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span>
        <span class="n">Cp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;padic_field&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Cp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Cp</span> <span class="o">=</span> <span class="n">QQp</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">w_minpoly</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">hom</span><span class="p">([</span><span class="n">Cp</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span> <span class="o">+</span> <span class="n">Cp</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Cp</span><span class="o">.</span><span class="n">gen</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
            <span class="n">gp</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">our_sqrt</span><span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">n</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">hom</span><span class="p">([</span><span class="n">gp</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">hom</span><span class="p">([</span><span class="n">mu</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">hom</span><span class="p">([</span><span class="n">mu</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">fwrite</span><span class="p">(</span>
            <span class="s2">&quot;# d_K = </span><span class="si">%s</span><span class="s2">, h_K = </span><span class="si">%s</span><span class="s2">, h_K^- = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">discriminant</span><span class="p">(),</span> <span class="n">K</span><span class="o">.</span><span class="n">class_number</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">narrow_class_group</span><span class="p">())),</span>
            <span class="n">outfile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# w is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">w</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# w_K satisfies: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">(),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# Cp has precision: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Cp</span><span class="o">.</span><span class="n">precision_cap</span><span class="p">(),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_order</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>

        <span class="n">iotap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_embedding</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>

        <span class="n">eps0</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">units</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">eps0</span>
        <span class="k">while</span> <span class="n">coords</span><span class="p">(</span><span class="n">eps</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">extra_conductor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">*=</span> <span class="n">eps0</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">eps</span><span class="p">))</span>

        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">iotap</span><span class="p">(</span><span class="n">gamma</span><span class="o">.</span><span class="n">quaternion_rep</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>

        <span class="n">DD</span> <span class="o">=</span> <span class="n">our_sqrt</span><span class="p">(</span><span class="n">Cp</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">tau1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">DD</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="n">DD</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>

        <span class="n">m1</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">Cp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">tau1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">Cp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">tau2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">iotap</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">()))</span><span class="o">.</span><span class="n">change_ring</span><span class="p">(</span><span class="n">Cp</span><span class="p">)</span> <span class="o">*</span> <span class="n">m1</span> <span class="o">!=</span> <span class="n">v0</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span> <span class="o">*</span> <span class="n">m1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">iotap</span><span class="p">(</span><span class="n">phi</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">()))</span><span class="o">.</span><span class="n">change_ring</span><span class="p">(</span><span class="n">Cp</span><span class="p">)</span> <span class="o">*</span> <span class="n">m2</span> <span class="o">==</span> <span class="n">v0</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span> <span class="o">*</span> <span class="n">m2</span>
            <span class="n">tau1</span><span class="p">,</span> <span class="n">tau2</span> <span class="o">=</span> <span class="n">tau2</span><span class="p">,</span> <span class="n">tau1</span>

        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# O_K to R_0 given by w_K |-&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">phi</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# gamma_psi = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# tau_psi satisfies </span><span class="si">%s</span><span class="s2"> = 0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">our_algdep</span><span class="p">(</span><span class="n">tau1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">factor</span><span class="p">()),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# tau_psi = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tau1</span><span class="p">),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span>
            <span class="s2">&quot;# (where </span><span class="si">{g}</span><span class="s2"> satisfies: </span><span class="si">{defpoly}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">g</span><span class="o">=</span><span class="n">Cp</span><span class="o">.</span><span class="n">_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">defpoly</span><span class="o">=</span><span class="n">Cp</span><span class="o">.</span><span class="n">defining_polynomial</span><span class="p">(</span><span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">outfile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">tau1</span><span class="p">,</span> <span class="n">tau2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">tau1</span></div>


<div class="viewcode-block" id="ArithGroup_rationalquaternion.element_of_norm">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalquaternion.element_of_norm">[docs]</a>
    <span class="nd">@cached_method</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">use_magma</span><span class="p">,</span> <span class="n">return_all</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">max_elements</span><span class="p">:</span> <span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">N</span><span class="p">,</span>
            <span class="n">return_all</span><span class="p">,</span>
            <span class="n">max_elements</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">element_of_norm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">use_magma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">radius</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_elements</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">):</span>  <span class="c1"># in rationalquaternion</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">force_sign</span> <span class="o">=</span> <span class="ow">not</span> <span class="s2">&quot;P&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span>
        <span class="k">if</span> <span class="n">use_magma</span><span class="p">:</span>
            <span class="c1"># assert return_all == False</span>
            <span class="n">elt_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span><span class="o">.</span><span class="n">ElementOfNorm</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="o">.</span><span class="n">Integers</span><span class="p">())</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">magma_F_elt_to_sage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">elt_magma</span><span class="o">.</span><span class="n">Vector</span><span class="p">()[</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">force_sign</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_sign</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
            <span class="c1"># assert candidate.reduced_norm() == N</span>
            <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">candidate</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">candidate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_O_basis</span><span class="p">())</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Doing long enumeration...&quot;</span><span class="p">)</span>
            <span class="n">M</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
                <span class="n">all_candidates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">M</span> <span class="o">!=</span> <span class="n">radius</span><span class="p">:</span>
                <span class="n">M</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;M = </span><span class="si">%s</span><span class="s2">,radius = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;v = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">a0</span><span class="p">,</span> <span class="n">an</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">,</span> <span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">candidate</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">ZZ</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span> <span class="o">*</span> <span class="n">vi</span> <span class="k">for</span> <span class="n">ai</span><span class="p">,</span> <span class="n">vi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">a0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">an</span><span class="p">),</span> <span class="n">v</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">()</span> <span class="o">==</span> <span class="n">N</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_all</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">candidate</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">all_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_candidates</span><span class="p">)</span> <span class="o">==</span> <span class="n">max_elements</span><span class="p">:</span>
                                <span class="n">verbose</span><span class="p">(</span>
                                    <span class="s2">&quot;Found </span><span class="si">%s</span><span class="s2"> elements of requested norm&quot;</span>
                                    <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_candidates</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="k">return</span> <span class="n">all_candidates</span>
            <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%s</span><span class="s2"> elements of requested norm&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_candidates</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">all_candidates</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Not found&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArithGroup_rationalquaternion.non_positive_unit">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalquaternion.non_positive_unit">[docs]</a>
    <span class="nd">@cached_method</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">non_positive_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_O_basis</span><span class="p">()</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Doing long enumeration...&quot;</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">M</span> <span class="o">!=</span> <span class="n">radius</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;M = </span><span class="si">%s</span><span class="s2">,radius = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">a0</span><span class="p">,</span> <span class="n">an</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ai</span> <span class="o">*</span> <span class="n">vi</span> <span class="k">for</span> <span class="n">ai</span><span class="p">,</span> <span class="n">vi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">a0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">an</span><span class="p">),</span> <span class="n">v</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">candidate</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">candidate</span></div>
</div>



<div class="viewcode-block" id="ArithGroup_rationalmatrix">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix">[docs]</a>
<span class="k">class</span> <span class="nc">ArithGroup_rationalmatrix</span><span class="p">(</span><span class="n">ArithGroup_matrix_generic</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">level</span><span class="p">,</span>
        <span class="n">info_magma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">grouptype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">magma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compute_presentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sage.modular.arithgroup.congroup_gammaH</span> <span class="kn">import</span> <span class="n">GammaH_constructor</span>

        <span class="k">if</span> <span class="n">grouptype</span> <span class="o">==</span> <span class="s2">&quot;PGL2&quot;</span><span class="p">:</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Changing grouptype to PSL2!!&quot;</span><span class="p">)</span>
            <span class="n">grouptype</span> <span class="o">=</span> <span class="s2">&quot;PSL2&quot;</span>
        <span class="k">elif</span> <span class="n">grouptype</span> <span class="o">==</span> <span class="s2">&quot;GL2&quot;</span><span class="p">:</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Changing grouptype to SL2!!&quot;</span><span class="p">)</span>
            <span class="n">grouptype</span> <span class="o">=</span> <span class="s2">&quot;SL2&quot;</span>
        <span class="k">assert</span> <span class="n">grouptype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SL2&quot;</span><span class="p">,</span> <span class="s2">&quot;PSL2&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span> <span class="o">=</span> <span class="n">grouptype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_presentation</span> <span class="o">=</span> <span class="n">compute_presentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magma</span> <span class="o">=</span> <span class="n">magma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">QQ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discriminant</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma0_farey</span> <span class="o">=</span> <span class="n">GammaH_constructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">farey_symbol</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nebentypus</span> <span class="o">=</span> <span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma0_farey</span> <span class="o">=</span> <span class="n">GammaH_constructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">level</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">farey_symbol</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_units</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prec_inf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">MatrixSpace</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">temp_relation_words</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">SL2Z</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">SL2Z</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">minus_one</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Gamma0_farey</span><span class="o">.</span><span class="n">generators</span><span class="p">()):</span>
            <span class="n">newg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">a</span><span class="p">(),</span> <span class="n">g</span><span class="o">.</span><span class="n">b</span><span class="p">(),</span> <span class="n">g</span><span class="o">.</span><span class="n">c</span><span class="p">(),</span> <span class="n">g</span><span class="o">.</span><span class="n">d</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">newg</span> <span class="o">==</span> <span class="n">I</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">newg</span><span class="o">.</span><span class="n">set_immutable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">element_class</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">quaternion_rep</span><span class="o">=</span><span class="n">newg</span><span class="p">,</span> <span class="n">word_rep</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">matrix</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">I</span><span class="o">.</span><span class="n">matrix</span><span class="p">():</span>
                <span class="n">temp_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">minus_one</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">temp_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="n">minus_one</span><span class="p">)</span>
                <span class="n">minus_one</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">matrix</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">E</span><span class="o">.</span><span class="n">matrix</span><span class="p">():</span>
                <span class="n">temp_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">minus_one</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">temp_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)]</span> <span class="o">+</span> <span class="n">minus_one</span><span class="p">)</span>
                <span class="n">minus_one</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">matrix</span><span class="p">()</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">==</span> <span class="n">I</span><span class="o">.</span><span class="n">matrix</span><span class="p">():</span>
                <span class="n">temp_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">matrix</span><span class="p">()</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">==</span> <span class="n">E</span><span class="o">.</span><span class="n">matrix</span><span class="p">():</span>
                <span class="n">temp_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">minus_one</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">temp_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)]</span> <span class="o">+</span> <span class="n">minus_one</span><span class="p">)</span>
                <span class="n">minus_one</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">matrix</span><span class="p">()</span> <span class="o">**</span> <span class="mi">24</span> <span class="o">!=</span> <span class="n">I</span><span class="o">.</span><span class="n">matrix</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_unit_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">minus_one</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minus_one_long</span> <span class="o">=</span> <span class="n">syllables_to_tietze</span><span class="p">(</span><span class="n">minus_one</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">temp_relation_words</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="n">prod</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">quaternion_rep</span> <span class="o">**</span> <span class="n">a</span> <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rel</span><span class="p">),</span> <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;P&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syllables_to_tietze</span><span class="p">(</span><span class="n">rel</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">sign</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">newrel</span> <span class="o">=</span> <span class="n">rel</span> <span class="o">+</span> <span class="n">tietze_to_syllables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minus_one_long</span><span class="p">)</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="n">prod</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gens</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">quaternion_rep</span> <span class="o">**</span> <span class="n">a</span> <span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">newrel</span><span class="p">),</span>
                    <span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="k">assert</span> <span class="n">sign</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">syllables_to_tietze</span><span class="p">(</span><span class="n">newrel</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ArithGroup_generic</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Matrix Arithmetic Group of level = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">QQ</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span> <span class="n">d</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_quaternion_to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>

<div class="viewcode-block" id="ArithGroup_rationalmatrix.fundamental_domain">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.fundamental_domain">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">fundamental_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">AA</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span> <span class="o">*</span> <span class="n">AA</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(),</span> <span class="n">rho</span><span class="p">,</span> <span class="n">rho</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="ArithGroup_rationalmatrix.get_archimedean_embedding">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.get_archimedean_embedding">[docs]</a>
    <span class="k">def</span> <span class="nf">get_archimedean_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># matrix</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an embedding of the quaternion algebra</span>
<span class="sd">        into the algebra of 2x2 matrices with coefficients in `\QQ_p`.</span>

<span class="sd">        INPUT:</span>

<span class="sd">        - prec -- Integer. The precision of the splitting.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span></div>


<div class="viewcode-block" id="ArithGroup_rationalmatrix.fundamental_domain_data">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.fundamental_domain_data">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">fundamental_domain_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of triples (v_i, v_{i+1}, g_i),</span>
<span class="sd">        where the v_i are vertices of a fundamental domain D,</span>
<span class="sd">        and the g_i are matrices, such that</span>
<span class="sd">        (g_i * D) cap D = (v_i, v_{i+1}).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">AA</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
        <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Infinity</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">T</span><span class="o">**-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rho</span><span class="p">,</span> <span class="n">rho</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">S</span><span class="p">))</span>
        <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">rho</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Infinity</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ans</span></div>


<div class="viewcode-block" id="ArithGroup_rationalmatrix.is_in_fundom">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.is_in_fundom">[docs]</a>
    <span class="k">def</span> <span class="nf">is_in_fundom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="n">Infinity</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">==</span> <span class="n">Infinity</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">t</span><span class="o">.</span><span class="n">real_part</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="ArithGroup_rationalmatrix.find_fundom_rep">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.find_fundom_rep">[docs]</a>
    <span class="k">def</span> <span class="nf">find_fundom_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># rational matrix</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns t0 and g such that g*t0 = tau, and t0 is in the fundamental domain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">v0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="s2">&quot;norm&quot;</span><span class="p">):</span>
            <span class="n">nrm</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nrm</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">v0</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">tau</span><span class="o">.</span><span class="n">real_part</span><span class="p">()</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span>
            <span class="n">tau</span> <span class="o">-=</span> <span class="n">t</span>
            <span class="k">if</span> <span class="n">tau</span><span class="o">.</span><span class="n">real_part</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">tau</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">nrm</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">tau</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tau</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">ZZ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">tau</span><span class="p">,</span> <span class="n">g</span></div>


<div class="viewcode-block" id="ArithGroup_rationalmatrix.mat_list">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.mat_list">[docs]</a>
    <span class="k">def</span> <span class="nf">mat_list</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_fundom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>  <span class="c1"># rationalmatrix</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list S of matrices such that the geodesic (x1, x2) is contained in the union</span>
<span class="sd">        of the translates s*D (with s in S) of the standard fundamental domain D.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="n">x1</span> <span class="o">+=</span> <span class="n">CC</span><span class="o">.</span><span class="n">random_element</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x1</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">x2</span> <span class="o">+=</span> <span class="n">CC</span><span class="o">.</span><span class="n">random_element</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x2</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">sage.repl.rich_output.pretty_print</span> <span class="kn">import</span> <span class="n">show</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_debug_plot</span> <span class="o">=</span> <span class="n">hyperbolic_polygon</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">CC</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">10</span> <span class="o">^</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">CC</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">10</span> <span class="o">^</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">v0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>

        <span class="c1"># We first deal with the case of x1 or x2 being Infinity</span>
        <span class="k">if</span> <span class="n">x1</span> <span class="o">==</span> <span class="n">Infinity</span> <span class="ow">or</span> <span class="n">x2</span> <span class="o">==</span> <span class="n">Infinity</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Calling mat_list with x1 = </span><span class="si">%s</span><span class="s2"> and x2 = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">show</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug_plot</span> <span class="o">+</span> <span class="n">hyperbolic_arc</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
        <span class="n">x1_orig</span> <span class="o">=</span> <span class="n">x1</span>
        <span class="n">x2_orig</span> <span class="o">=</span> <span class="n">x2</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">g</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">check_fundom</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">x1</span><span class="p">):</span>
            <span class="n">t0</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_fundom_rep</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">t0</span><span class="p">,</span> <span class="bp">self</span><span class="p">(</span><span class="n">g</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">x2</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">show</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug_plot</span> <span class="o">+</span> <span class="n">hyperbolic_arc</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;x1 = </span><span class="si">%s</span><span class="s2">, x2 = </span><span class="si">%s</span><span class="s2"> (move to fundom)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>

        <span class="c1"># Here we can assume that x1 is in the fundamental domain</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">(</span><span class="n">g</span><span class="p">)]</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">x2</span><span class="p">):</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">candidate_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fundamental_domain_data</span><span class="p">():</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">intersect_geodesic_arcs</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">candidate_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">z</span><span class="p">,</span> <span class="n">g</span><span class="p">))</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;len(candidate_list) = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_list</span><span class="p">))</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;:-(&quot;</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">z</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">candidate_list</span><span class="p">:</span>
                <span class="c1"># We take a perturbation of z to avoid boundary problems</span>
                <span class="n">eps</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>
                <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">perturb_point_on_arc</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">z1</span><span class="p">):</span>
                    <span class="n">z1</span><span class="p">,</span> <span class="n">z2</span> <span class="o">=</span> <span class="n">z2</span><span class="p">,</span> <span class="n">z1</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">z1</span><span class="p">),</span> <span class="s2">&quot;z1 and z2 are both outside of fundom!&quot;</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">z2</span><span class="p">),</span> <span class="s2">&quot;z1 and z2 are both inside of fundom!&quot;</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">g</span><span class="o">**-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">z2</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;t0 = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">t0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">show</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_debug_plot</span>
                        <span class="o">+</span> <span class="n">hyperbolic_arc</span><span class="p">(</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">point2d</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_in_fundom</span><span class="p">(</span><span class="n">t0</span><span class="p">):</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">t0</span>
                    <span class="n">x2</span> <span class="o">=</span> <span class="n">g</span><span class="o">**-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">x2</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">show</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_debug_plot</span> <span class="o">+</span> <span class="n">hyperbolic_arc</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
                    <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;x1 = </span><span class="si">%s</span><span class="s2">, x2 = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span>
                    <span class="n">ans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">assert</span> <span class="n">found</span>
        <span class="k">return</span> <span class="n">ans</span></div>


<div class="viewcode-block" id="ArithGroup_rationalmatrix.generate_wp_candidates">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.generate_wp_candidates">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_wp_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ideal_p</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># rationalmatrix</span>
        <span class="n">initial_wp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_wp&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ideal_p</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ideal_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">yield</span> <span class="n">ans</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Follow Atkin--Li</span>
            <span class="k">if</span> <span class="n">initial_wp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">ideal_p</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>
                <span class="n">g</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">xgcd</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">)</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">w</span><span class="p">])</span>
                <span class="n">all_initial</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">)):</span>
                    <span class="n">g</span><span class="p">,</span> <span class="n">tinv</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">xgcd</span><span class="p">(</span><span class="o">-</span><span class="n">p</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">g</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">new_initial</span> <span class="o">=</span> <span class="n">ans</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="n">tinv</span><span class="p">])</span>
                        <span class="n">all_initial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_initial</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_initial</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_wp</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">cantor_diagonal</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_elements</span><span class="p">(</span><span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_elements</span><span class="p">(</span><span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">all_initial</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">v2</span></div>


    <span class="c1"># rationalmatrix</span>
<div class="viewcode-block" id="ArithGroup_rationalmatrix.embed_order">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.embed_order">[docs]</a>
    <span class="k">def</span> <span class="nf">embed_order</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">p</span><span class="p">,</span>
        <span class="n">D</span><span class="p">,</span>
        <span class="n">prec</span><span class="p">,</span>
        <span class="n">orientation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_magma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">extra_conductor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.limits</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">_find_initial_embedding_list</span><span class="p">,</span>
            <span class="n">find_optimal_embeddings</span><span class="p">,</span>
            <span class="n">order_and_unit</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>
        <span class="n">extra_conductor</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">extra_conductor</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_ring</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">-</span> <span class="n">D</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">maximal_order</span><span class="p">()</span><span class="o">.</span><span class="n">ring_generators</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">coordinates_in_terms_of_powers</span><span class="p">()(</span><span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span>
        <span class="n">QQp</span> <span class="o">=</span> <span class="n">Qp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
        <span class="n">Cp</span> <span class="o">=</span> <span class="n">QQp</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">(),</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">hom</span><span class="p">([</span><span class="n">r0</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="n">Cp</span><span class="o">.</span><span class="n">gen</span><span class="p">()])</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">find_optimal_embeddings</span><span class="p">(</span>
            <span class="n">K</span><span class="p">,</span> <span class="n">use_magma</span><span class="o">=</span><span class="n">use_magma</span><span class="p">,</span> <span class="n">extra_conductor</span><span class="o">=</span><span class="n">extra_conductor</span><span class="p">,</span> <span class="n">magma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magma</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">OD</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">order_and_unit</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">extra_conductor</span><span class="p">)</span>
        <span class="n">wD</span> <span class="o">=</span> <span class="n">OD</span><span class="o">.</span><span class="n">ring_generators</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wDvec</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">coordinates_in_terms_of_powers</span><span class="p">()(</span><span class="n">wD</span><span class="p">)</span>
        <span class="n">WD</span> <span class="o">=</span> <span class="n">wDvec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">wDvec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">W</span>
        <span class="n">tau</span><span class="p">,</span> <span class="n">gamma</span> <span class="o">=</span> <span class="n">_find_initial_embedding_list</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">WD</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">OD</span><span class="p">,</span> <span class="n">u</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">gamma</span><span class="o">.</span><span class="n">set_immutable</span><span class="p">()</span>

        <span class="n">padic_field</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;padic_field&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">padic_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Cp</span> <span class="o">=</span> <span class="n">padic_field</span>

        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">DD</span> <span class="o">=</span> <span class="n">our_sqrt</span><span class="p">(</span><span class="n">Cp</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">tau1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">DD</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="n">DD</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>

        <span class="n">padic_field</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;padic_field&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">padic_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Cp</span> <span class="o">=</span> <span class="n">padic_field</span>

        <span class="n">DD</span> <span class="o">=</span> <span class="n">our_sqrt</span><span class="p">(</span><span class="n">Cp</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">tau1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">DD</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="n">DD</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>

        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# gamma_psi = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# tau_psi satisfies </span><span class="si">%s</span><span class="s2"> = 0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">our_algdep</span><span class="p">(</span><span class="n">tau1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">factor</span><span class="p">()),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# tau_psi = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tau1</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span>
            <span class="s2">&quot;# (where </span><span class="si">{g}</span><span class="s2"> satisfies: </span><span class="si">{defpoly}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">g</span><span class="o">=</span><span class="n">Cp</span><span class="o">.</span><span class="n">_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">defpoly</span><span class="o">=</span><span class="n">Cp</span><span class="o">.</span><span class="n">defining_polynomial</span><span class="p">(</span><span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">outfile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="n">tau1</span><span class="p">,</span> <span class="n">tau2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span> <span class="n">tau1</span></div>


<div class="viewcode-block" id="ArithGroup_rationalmatrix.embed_order_legacy">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.embed_order_legacy">[docs]</a>
    <span class="k">def</span> <span class="nf">embed_order_legacy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.limits</span> <span class="kn">import</span> <span class="p">(</span>
            <span class="n">_find_initial_embedding_list</span><span class="p">,</span>
            <span class="n">find_optimal_embeddings</span><span class="p">,</span>
            <span class="n">find_the_unit_of</span><span class="p">,</span>
            <span class="n">order_and_unit</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_ring</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">-</span> <span class="n">D</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Computing quadratic embedding to precision </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">prec</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">find_optimal_embeddings</span><span class="p">(</span>
            <span class="n">K</span><span class="p">,</span> <span class="n">use_magma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extra_conductor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">magma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">magma</span>
        <span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Finding module generators&quot;</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">module_generators</span><span class="p">(</span><span class="n">K</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
        <span class="n">w_minpoly</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">()</span><span class="o">.</span><span class="n">change_ring</span><span class="p">(</span><span class="n">Qp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prec</span><span class="p">))</span>
        <span class="n">Cp</span> <span class="o">=</span> <span class="n">Qp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">w_minpoly</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
        <span class="n">wl</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="o">-</span><span class="n">wl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">wl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">wl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="n">w</span> <span class="o">==</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">padic_Kgen</span> <span class="o">=</span> <span class="n">Cp</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span> <span class="o">+</span> <span class="n">Cp</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span> <span class="o">*</span> <span class="n">Cp</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fwrite</span><span class="p">(</span>
                <span class="s2">&quot;# d_K = </span><span class="si">%s</span><span class="s2">, h_K = </span><span class="si">%s</span><span class="s2">, h_K^- = </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">discriminant</span><span class="p">(),</span> <span class="n">K</span><span class="o">.</span><span class="n">class_number</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">narrow_class_group</span><span class="p">())),</span>
                <span class="n">outfile</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# w_K satisfies: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">(),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="n">mu</span>
        <span class="k">assert</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">==</span> <span class="n">mu</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="ow">and</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span> <span class="o">==</span> <span class="n">mu</span><span class="o">.</span><span class="n">determinant</span><span class="p">()</span>
        <span class="n">iotap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_embedding</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">iotap</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Cp</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">tau1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padic_Kgen</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padic_Kgen</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Cp</span><span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau1</span> <span class="o">-</span> <span class="n">Cp</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Cp</span><span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau2</span> <span class="o">-</span> <span class="n">Cp</span><span class="p">(</span><span class="n">b</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">find_the_unit_of</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
        <span class="n">gammalst</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">gammalst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">gammaquatrep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">gammalst</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">gammalst</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">mu</span>
        <span class="n">verbose</span><span class="p">(</span>
            <span class="s2">&quot;gammaquatrep trd = </span><span class="si">%s</span><span class="s2"> and nrd = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">gammaquatrep</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="n">gammaquatrep</span><span class="o">.</span><span class="n">determinant</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;u trace = </span><span class="si">%s</span><span class="s2"> and unorm = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">trace</span><span class="p">(),</span> <span class="n">u</span><span class="o">.</span><span class="n">norm</span><span class="p">()))</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">gammaquatrep</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="o">==</span> <span class="n">u</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span> <span class="ow">and</span> <span class="n">gammaquatrep</span><span class="o">.</span><span class="n">determinant</span><span class="p">()</span> <span class="o">==</span> <span class="n">u</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">gammaq</span> <span class="o">=</span> <span class="n">gammaquatrep</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">gammaq</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">gammaq</span> <span class="o">*=</span> <span class="n">gammaquatrep</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">iotap</span><span class="p">(</span><span class="n">gamma</span><span class="o">.</span><span class="n">quaternion_rep</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">tau1</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">tau1</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# O_K to R_0 given by w_K |-&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mu</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# gamma_psi = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# tau_psi satisfies </span><span class="si">%s</span><span class="s2"> = 0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">our_algdep</span><span class="p">(</span><span class="n">tau1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">factor</span><span class="p">()),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# tau_psi = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tau1</span><span class="p">),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# (where g satisfies: </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">(),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">tau1</span><span class="p">,</span> <span class="n">tau2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">tau1</span></div>


<div class="viewcode-block" id="ArithGroup_rationalmatrix.get_word_rep">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.get_word_rep">[docs]</a>
    <span class="k">def</span> <span class="nf">get_word_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>  <span class="c1"># rationalmatrix</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma0_farey</span><span class="o">.</span><span class="n">word_problem</span><span class="p">(</span><span class="n">SL2Z</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">list</span><span class="p">()),</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma0_farey</span><span class="o">.</span><span class="n">word_problem</span><span class="p">(</span>
                        <span class="n">SL2Z</span><span class="p">((</span><span class="o">-</span><span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()),</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">AssertionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Delta = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">delta</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Message: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">assert</span> <span class="mi">0</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">multiply_out</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">())</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">SL2Z</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">list</span><span class="p">())</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">*</span> <span class="n">tmp</span><span class="o">**-</span><span class="mi">1</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">SL2Z</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">SL2Z</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">gens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Gamma0_farey</span><span class="o">.</span><span class="n">generators</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">I</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_word</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">matrix</span><span class="p">(),</span> <span class="n">ans</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">err</span> <span class="o">==</span> <span class="n">E</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus_one_long</span> <span class="o">+</span> <span class="n">ans</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_word</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">matrix</span><span class="p">(),</span> <span class="n">ans</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArithGroup_rationalmatrix.element_of_norm">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.element_of_norm">[docs]</a>
    <span class="nd">@cached_method</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">use_magma</span><span class="p">,</span> <span class="n">return_all</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">max_elements</span><span class="p">:</span> <span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">N</span><span class="p">,</span>
            <span class="n">return_all</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">element_of_norm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">use_magma</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_elements</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>  <span class="c1"># in rationalmatrix</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">([</span><span class="n">N</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">set_immutable</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">candidate</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">candidate</span></div>


<div class="viewcode-block" id="ArithGroup_rationalmatrix.non_positive_unit">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_rationalmatrix.non_positive_unit">[docs]</a>
    <span class="k">def</span> <span class="nf">non_positive_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span></div>


    <span class="k">def</span> <span class="nf">_is_in_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">denominator</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">entries</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;nebentypus&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nebentypus</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="ArithGroup_nf_generic">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_generic">[docs]</a>
<span class="k">class</span> <span class="nc">ArithGroup_nf_generic</span><span class="p">(</span><span class="n">ArithGroup_generic</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base</span><span class="p">,</span>
        <span class="n">a</span><span class="p">,</span>
        <span class="n">b</span><span class="p">,</span>
        <span class="n">level</span><span class="p">,</span>
        <span class="n">info_magma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">grouptype</span><span class="o">=</span><span class="s2">&quot;PSL2&quot;</span><span class="p">,</span>
        <span class="n">magma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">compute_presentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span>
            <span class="s2">&quot;Calling ArithGroup_nf_generic with parameters: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magma</span> <span class="o">=</span> <span class="n">magma</span>
        <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">signature</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;jv&quot;</span>
        <span class="k">elif</span> <span class="n">base</span><span class="o">.</span><span class="n">signature</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="s2">&quot;aurel&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;At most one complex place!&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">grouptype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;SL2&quot;</span><span class="p">,</span> <span class="s2">&quot;PSL2&quot;</span><span class="p">,</span> <span class="s2">&quot;GL2&quot;</span><span class="p">,</span> <span class="s2">&quot;PGL2&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prec_inf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span> <span class="o">=</span> <span class="n">grouptype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_presentation</span> <span class="o">=</span> <span class="n">compute_presentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_elements_of_prime_norm</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">info_magma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">base</span> <span class="ow">is</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">F</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">invariants</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">base</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">base</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abtuple</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">F</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">B</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">base</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">base</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">base</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abtuple</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">QuaternionAlgebra</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_magma_objects</span><span class="p">(</span><span class="n">info_magma</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_presentation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_geometric_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">invariants</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Arithmetic Group attached to quaternion algebra with a = </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">, b = </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2"> and level = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_init_magma_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info_magma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># NF generic</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes different Magma objects needed for calculations:</span>

<span class="sd">        - self._F_magma (base number field)</span>
<span class="sd">        - self._B_magma (quaternion algebra)</span>
<span class="sd">        - self._Omax_magma (maximal order in quaternion algebra)</span>
<span class="sd">        - self._O_magma</span>
<span class="sd">        - self._D_magma</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wtime</span> <span class="o">=</span> <span class="n">walltime</span><span class="p">()</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Calling _init_magma_objects...&quot;</span><span class="p">)</span>
        <span class="c1"># Use order given by Pari/GP</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">maximal_order</span><span class="p">()</span><span class="o">.</span><span class="n">ring_generators</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wcoords</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">coordinates_in_terms_of_powers</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="n">getfile</span><span class="p">(</span><span class="n">currentframe</span><span class="p">())))</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Path = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;default(sopath, &quot;</span><span class="si">%s</span><span class="s1">/Fdoms&quot;)&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">r </span><span class="si">%s</span><span class="s2">/Fdoms/fdom.gp&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="n">yp</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">variable</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">Fp</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">nfinit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">QQ</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">](</span><span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">())))</span>
        <span class="n">abtuple</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">]</span>
        <span class="n">Ap</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">alginit</span><span class="p">(</span><span class="n">Fp</span><span class="p">,</span> <span class="p">[</span><span class="n">QQ</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">](</span><span class="n">wcoords</span><span class="p">(</span><span class="n">o</span><span class="p">))</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">abtuple</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ap</span> <span class="o">=</span> <span class="n">Ap</span>

        <span class="k">if</span> <span class="n">info_magma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Qx_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">PolynomialRing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Rationals</span><span class="p">())</span>
            <span class="n">xm</span> <span class="o">=</span> <span class="n">Qx_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span><span class="o">.</span><span class="n">minpoly</span><span class="p">()</span>
            <span class="n">fmagma</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="p">(</span><span class="n">ZZ</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="o">*</span> <span class="n">xm</span><span class="o">**</span><span class="n">i</span>
                    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">coefficients</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">exponents</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">FF_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">RationalsAsNumberField</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">FF_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">NumberField</span><span class="p">(</span><span class="n">fmagma</span><span class="p">,</span> <span class="n">DoLinearExtension</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span> <span class="o">=</span> <span class="n">FF_magma</span>
            <span class="n">OF_magma</span> <span class="o">=</span> <span class="n">FF_magma</span><span class="o">.</span><span class="n">Integers</span><span class="p">()</span>
            <span class="n">am</span><span class="p">,</span> <span class="n">bm</span> <span class="o">=</span> <span class="n">sage_F_elt_to_magma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">),</span> <span class="n">sage_F_elt_to_magma</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">QuaternionAlgebra</span><span class="p">(</span><span class="n">FF_magma</span><span class="p">,</span> <span class="n">am</span><span class="p">,</span> <span class="n">bm</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ArithGroup_matrix_generic</span><span class="p">):</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">j</span>
                <span class="n">on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">One</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span>
                    <span class="p">[(</span><span class="n">on</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">on</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Omaxbasis</span> <span class="o">=</span> <span class="n">pari_ordmax_basis_to_sage</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">Ap</span><span class="p">)</span>
                <span class="n">Omaxbasis</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">quaternion_to_magma_quaternion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">Omaxbasis</span>
                <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">Omaxbasis</span><span class="p">)</span>
                <span class="c1"># self._Omax_magma = MaximalOrder()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ArithGroup_matrix_generic</span><span class="p">):</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">j</span>
                    <span class="n">Pgen</span> <span class="o">=</span> <span class="n">sage_F_elt_to_magma</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">One</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span>
                        <span class="p">[(</span><span class="n">on</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Pgen</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">on</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span>
                        <span class="n">sage_F_ideal_to_magma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_D_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">UnitDisc</span><span class="p">(</span><span class="n">Precision</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_F_magma</span>
            <span class="n">OF_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_F_magma</span><span class="o">.</span><span class="n">Integers</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_B_magma</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_Omax_magma</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ArithGroup_matrix_generic</span><span class="p">):</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">j</span>
                    <span class="n">Pgen</span> <span class="o">=</span> <span class="n">sage_F_elt_to_magma</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">One</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span>
                        <span class="p">[(</span><span class="n">on</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Pgen</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">on</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">M</span> <span class="o">=</span> <span class="n">sage_F_ideal_to_magma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_Omax_magma</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_D_magma</span> <span class="o">=</span> <span class="n">info_magma</span><span class="o">.</span><span class="n">_D_magma</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_D_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">UnitDisc</span><span class="p">(</span><span class="n">Precision</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_F_magma&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="o">.</span><span class="n">BaseRing</span><span class="p">()</span>

        <span class="c1"># Create pari order</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Spent </span><span class="si">%s</span><span class="s2"> seconds in init_magma_objects&quot;</span> <span class="o">%</span> <span class="n">walltime</span><span class="p">(</span><span class="n">wtime</span><span class="p">))</span>

    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">_get_O_pari</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">maximal_order</span><span class="p">()</span><span class="o">.</span><span class="n">ring_generators</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sage_order_basis_to_pari</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_O_basis</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_quaternion_to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">coefficient_tuple</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">list</span><span class="p">()]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_basis_invmat</span><span class="p">()</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">(</span><span class="n">QQ</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">degree</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">xlist</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">V</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">degree</span><span class="p">())]</span>

    <span class="k">def</span> <span class="nf">_is_in_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">is_integral</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quaternion_to_list</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span>

    <span class="c1"># nf_quaternion</span>
<div class="viewcode-block" id="ArithGroup_nf_generic.compute_quadratic_embedding">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_generic.compute_quadratic_embedding">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_quadratic_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">return_generator</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">O_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Omax_magma</span>
        <span class="n">F_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span>

        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_ring</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">-</span> <span class="n">D</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span>

        <span class="n">Fxmagma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">PolynomialRing</span><span class="p">(</span><span class="n">F_magma</span><span class="p">)</span>
        <span class="n">Fxmagma</span><span class="o">.</span><span class="n">assign_names</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">xm</span> <span class="o">=</span> <span class="n">Fxmagma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">sage_F_elt_to_magma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">*</span> <span class="n">xm</span><span class="o">**</span><span class="n">i</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">coefficients</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">exponents</span><span class="p">())</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">K_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">NumberField</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span>
        <span class="n">OK_magma</span> <span class="o">=</span> <span class="n">K_magma</span><span class="o">.</span><span class="n">MaximalOrder</span><span class="p">()</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Calling magma Embed function...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">iota</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">Embed</span><span class="p">(</span><span class="n">OK_magma</span><span class="p">,</span> <span class="n">O_magma</span><span class="p">,</span> <span class="n">nvals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An error ocurred!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OK_magma = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">OK_magma</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;O_magma =&quot;</span> <span class="o">%</span> <span class="n">O_magma</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error while computing quadratic embedding&quot;</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Calling magma Embed function done!&quot;</span><span class="p">)</span>

        <span class="n">wm</span> <span class="o">=</span> <span class="n">K_magma</span><span class="p">(</span><span class="n">OK_magma</span><span class="o">.</span><span class="n">Basis</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">K</span><span class="p">(</span>
            <span class="n">magma_F_elt_to_sage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">wm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">magma_F_elt_to_sage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">wm</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="p">)</span> <span class="o">*</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">magma_integral_quaternion_to_sage</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">O_magma</span><span class="p">,</span> <span class="n">F_magma</span><span class="p">,</span> <span class="n">iota</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">OK_magma</span><span class="p">(</span><span class="n">K_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">ans</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">()</span> <span class="o">==</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">ans</span><span class="o">.</span><span class="n">reduced_trace</span><span class="p">()</span> <span class="o">==</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_generator</span><span class="p">:</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;w = </span><span class="si">%s</span><span class="s2">, minpoly = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">()))</span>
            <span class="k">assert</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">K</span><span class="o">.</span><span class="n">maximal_order</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ans</span><span class="p">,</span> <span class="n">w</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ans</span></div>


    <span class="c1"># nf_quaternion</span>
<div class="viewcode-block" id="ArithGroup_nf_generic.embed_order">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_generic.embed_order">[docs]</a>
    <span class="k">def</span> <span class="nf">embed_order</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">p</span><span class="p">,</span>
        <span class="n">D</span><span class="p">,</span>
        <span class="n">prec</span><span class="p">,</span>
        <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">extra_conductor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">F_to_Qp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Computing quadratic embedding to precision </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">prec</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_ring</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;t&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">t</span> <span class="o">-</span> <span class="n">D</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_quadratic_embedding</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">return_generator</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Finding module generators&quot;</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">module_generators</span><span class="p">(</span><span class="n">K</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
        <span class="n">w_minpoly</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Qp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prec</span><span class="p">),</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)(</span>
            <span class="p">[</span><span class="n">F_to_Qp</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">()</span><span class="o">.</span><span class="n">coefficients</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;w_minpoly = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">w_minpoly</span><span class="p">)</span>
        <span class="n">wl</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="o">-</span><span class="n">wl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">wl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">wl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">r1</span> <span class="o">*</span> <span class="n">w</span> <span class="o">==</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fwrite</span><span class="p">(</span>
                <span class="s2">&quot;# d_K = </span><span class="si">%s</span><span class="s2">, h_K = </span><span class="si">%s</span><span class="s2">, h_K^- = </span><span class="si">%s</span><span class="s2">&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">discriminant</span><span class="p">(),</span> <span class="n">K</span><span class="o">.</span><span class="n">class_number</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">narrow_class_group</span><span class="p">())),</span>
                <span class="n">outfile</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# w_K satisfies: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">w</span><span class="o">.</span><span class="n">minpoly</span><span class="p">(),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">base_ring</span><span class="p">())</span> <span class="o">==</span> <span class="n">mu</span><span class="o">.</span><span class="n">reduced_trace</span><span class="p">()</span>
            <span class="ow">and</span> <span class="n">K</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">base_ring</span><span class="p">())</span> <span class="o">==</span> <span class="n">mu</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">K</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>  <span class="c1"># K.gen().coordinates_in_terms_of_powers()</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">hom</span><span class="p">([</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">gen</span><span class="p">())],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">u0</span> <span class="o">=</span> <span class="n">find_the_unit_of</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">u0</span><span class="o">.</span><span class="n">is_integral</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">u0</span><span class="p">)</span><span class="o">.</span><span class="n">is_integral</span><span class="p">()</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u0</span>
        <span class="c1"># Deal with nontrivial conductor</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">extra_conductor</span><span class="p">)</span><span class="o">.</span><span class="n">divides</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">coords</span><span class="p">(</span><span class="n">u</span><span class="p">)[</span><span class="mi">1</span><span class="p">])):</span>
            <span class="n">u</span> <span class="o">*=</span> <span class="n">u0</span>
        <span class="n">gammalst</span> <span class="o">=</span> <span class="n">coords</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;gammalst = </span><span class="si">%s</span><span class="s2"> (length = </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gammalst</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gammalst</span><span class="p">)))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">gammalst</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">gammaquatrep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">gammalst</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">gammalst</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">mu</span>  <span class="c1"># phi(u)</span>
        <span class="n">verbose</span><span class="p">(</span>
            <span class="s2">&quot;gammaquatrep trd = </span><span class="si">%s</span><span class="s2"> and nrd = </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">gammaquatrep</span><span class="o">.</span><span class="n">reduced_trace</span><span class="p">(),</span> <span class="n">gammaquatrep</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">gammaquatrep</span><span class="o">.</span><span class="n">reduced_trace</span><span class="p">()</span> <span class="o">==</span> <span class="n">u</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">gammaquatrep</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">()</span> <span class="o">==</span> <span class="n">u</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">)</span>

        <span class="n">gammaq</span> <span class="o">=</span> <span class="n">gammaquatrep</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">gammaq</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">gammaq</span> <span class="o">*=</span> <span class="n">gammaquatrep</span>

        <span class="n">iotap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_embedding</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">iotap</span><span class="p">(</span><span class="n">gamma</span><span class="o">.</span><span class="n">quaternion_rep</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">padic_field</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;padic_field&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">padic_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Cp</span> <span class="o">=</span> <span class="n">padic_field</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Cp</span> <span class="o">=</span> <span class="n">Qp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">w_minpoly</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Cp is </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Cp</span><span class="p">)</span>

        <span class="n">DD</span> <span class="o">=</span> <span class="n">our_sqrt</span><span class="p">(</span><span class="n">Cp</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">tau1</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">DD</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="p">(</span><span class="n">Cp</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="n">DD</span><span class="p">)</span> <span class="o">/</span> <span class="n">Cp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>

        <span class="n">wlist</span> <span class="o">=</span> <span class="n">coords</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">wlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">wquatrep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">wlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">wlist</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">mu</span>  <span class="c1"># phi(w)</span>

        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# O_K to R_0 given by w_K |-&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">wquatrep</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# gamma_psi = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# tau_psi satisfies </span><span class="si">%s</span><span class="s2"> = 0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">our_algdep</span><span class="p">(</span><span class="n">tau1</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">factor</span><span class="p">()),</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span><span class="s2">&quot;# tau_psi = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">tau1</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>
        <span class="n">fwrite</span><span class="p">(</span>
            <span class="s2">&quot;# (where </span><span class="si">{g}</span><span class="s2"> satisfies: </span><span class="si">{defpoly}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">g</span><span class="o">=</span><span class="n">Cp</span><span class="o">.</span><span class="n">_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">defpoly</span><span class="o">=</span><span class="n">Cp</span><span class="o">.</span><span class="n">defining_polynomial</span><span class="p">(</span><span class="n">exact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">outfile</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">tau1</span><span class="p">,</span> <span class="n">tau2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">tau1</span></div>


<div class="viewcode-block" id="ArithGroup_nf_generic.element_of_prime_norm">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_generic.element_of_prime_norm">[docs]</a>
    <span class="k">def</span> <span class="nf">element_of_prime_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_norm</span><span class="p">,</span> <span class="n">radius</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_O_basis</span><span class="p">()</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Doing long enumeration...&quot;</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">base_ring</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">M</span> <span class="o">!=</span> <span class="n">radius</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;M = </span><span class="si">%s</span><span class="s2">,radius = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">a0</span><span class="p">,</span> <span class="n">an</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ai</span> <span class="o">*</span> <span class="n">vi</span> <span class="k">for</span> <span class="n">ai</span><span class="p">,</span> <span class="n">vi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">a0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">an</span><span class="p">),</span> <span class="n">v</span><span class="p">)))</span>
                <span class="n">candidate_norm</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">candidate_norm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">F</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">candidate_norm</span><span class="p">)</span><span class="o">.</span><span class="n">is_prime</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="n">candidate_norm</span><span class="o">.</span><span class="n">norm</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">max_norm</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_elements_of_prime_norm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="n">candidate</span></div>


<div class="viewcode-block" id="ArithGroup_nf_generic.element_of_norm">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_generic.element_of_norm">[docs]</a>
    <span class="nd">@cached_method</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">use_magma</span><span class="p">,</span> <span class="n">return_all</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">max_elements</span><span class="p">:</span> <span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">N</span><span class="p">,</span>
            <span class="n">return_all</span><span class="p">,</span>
            <span class="n">max_elements</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">element_of_norm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">use_magma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">radius</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_elements</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">):</span>  <span class="c1"># in nf_generic</span>
        <span class="n">Nideal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">force_sign</span> <span class="o">=</span> <span class="ow">not</span> <span class="s2">&quot;P&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span>
        <span class="k">if</span> <span class="n">return_all</span> <span class="ow">and</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_elements</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Radius must be positive&quot;</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">QQ</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">base_ring</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">K1</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">B</span><span class="o">.</span><span class="n">invariants</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;y1&quot;</span><span class="p">)</span>
            <span class="n">phi1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">NK1f</span> <span class="o">=</span> <span class="n">K1</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">Nideal</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">factor</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">NK1f</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">K2</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">extension</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">B</span><span class="o">.</span><span class="n">invariants</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="s2">&quot;y2&quot;</span><span class="p">)</span>
            <span class="n">phi2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">z</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">NK2f</span> <span class="o">=</span> <span class="n">K2</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">Nideal</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">factor</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">NK2f</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">found_candidate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NK1f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">gr</span> <span class="o">=</span> <span class="n">NK1f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">phi1</span><span class="p">(</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_order</span><span class="p">(</span><span class="n">candidate</span><span class="p">):</span>
                    <span class="n">found_candidate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_candidate</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">NK2f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">gr</span> <span class="o">=</span> <span class="n">NK2f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">phi2</span><span class="p">(</span><span class="n">gr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_in_order</span><span class="p">(</span><span class="n">candidate</span><span class="p">):</span>
                    <span class="n">found_candidate</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_candidate</span><span class="p">:</span>
            <span class="n">elt_magma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span><span class="o">.</span><span class="n">ElementOfNorm</span><span class="p">(</span>
                <span class="n">sage_F_ideal_to_magma</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="p">,</span> <span class="n">Nideal</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="n">magma_quaternion_to_sage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">elt_magma</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force_sign</span><span class="p">:</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_sign</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">candidate</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">candidate</span></div>


<div class="viewcode-block" id="ArithGroup_nf_generic.non_positive_unit">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_generic.non_positive_unit">[docs]</a>
    <span class="nd">@cached_method</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">:</span> <span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">non_positive_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_O_basis</span><span class="p">()</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Doing long enumeration...&quot;</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ideal_one</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">M</span> <span class="o">!=</span> <span class="n">radius</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;M = </span><span class="si">%s</span><span class="s2">,radius = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">radius</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">a0</span><span class="p">,</span> <span class="n">an</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">M</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">M</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">ai</span> <span class="o">*</span> <span class="n">vi</span> <span class="k">for</span> <span class="n">ai</span><span class="p">,</span> <span class="n">vi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">a0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">an</span><span class="p">),</span> <span class="n">v</span><span class="p">)))</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">candidate</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">())</span> <span class="o">==</span> <span class="n">ideal_one</span>
                    <span class="ow">and</span> <span class="n">candidate</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="n">candidate</span></div>
</div>



<div class="viewcode-block" id="ArithGroup_nf_fuchsian">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_fuchsian">[docs]</a>
<span class="k">class</span> <span class="nc">ArithGroup_nf_fuchsian</span><span class="p">(</span><span class="n">ArithGroup_nf_generic</span><span class="p">,</span> <span class="n">ArithGroup_fuchsian_generic</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_init_geometric_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># nf quaternion</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Timeout functionality not implemented yet&quot;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="n">Gm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">FuchsianGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Gm</span> <span class="o">=</span> <span class="n">Gm</span>  <span class="c1"># DEBUG</span>
        <span class="n">FDom_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="o">.</span><span class="n">FundamentalDomain</span><span class="p">()</span>  <span class="c1"># self._D_magma.name()) # Debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fundamental_domain</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ComplexField</span><span class="p">(</span><span class="mi">1000</span><span class="p">)(</span><span class="n">o</span><span class="o">.</span><span class="n">Real</span><span class="p">()</span><span class="o">.</span><span class="n">sage</span><span class="p">(),</span> <span class="n">o</span><span class="o">.</span><span class="n">Imaginary</span><span class="p">()</span><span class="o">.</span><span class="n">sage</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">FDom_magma</span>
        <span class="p">]</span>
        <span class="n">Um</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">m2_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">nvals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">magma_quaternion_to_sage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">(</span><span class="n">m2_magma</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">Um</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Um</span><span class="o">.</span><span class="n">gens</span><span class="p">()))</span>
        <span class="p">]</span>

        <span class="n">Uside_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="o">.</span><span class="n">get_magma_attribute</span><span class="p">(</span><span class="s2">&quot;ShimGroupSidepairs&quot;</span><span class="p">)</span>
        <span class="n">mside_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="o">.</span><span class="n">get_magma_attribute</span><span class="p">(</span><span class="s2">&quot;ShimGroupSidepairsMap&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Uside</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">magma_quaternion_to_sage</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">(</span><span class="n">m2_magma</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">mside_magma</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">g</span><span class="p">))),</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">Uside_magma</span><span class="o">.</span><span class="n">Generators</span><span class="p">()</span>
        <span class="p">]</span>

        <span class="c1"># We initialize some attributes by calling this function stupidly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">WordProblem</span><span class="p">(</span><span class="n">Gm</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">gquats_magma</span> <span class="o">=</span> <span class="n">Gm</span><span class="o">.</span><span class="n">get_magma_attribute</span><span class="p">(</span><span class="s2">&quot;ShimGroupSidepairsQuats&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngquats</span> <span class="o">=</span> <span class="n">ZZ</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gquats_magma</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">emb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_archimedean_embedding</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span> <span class="o">=</span> <span class="n">translate_into_twosided_list</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">magma_quaternion_to_sage</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_B_magma</span><span class="p">(</span><span class="n">gquats_magma</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Quaternion</span><span class="p">()),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gquats_magma</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embgquats</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">emb</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">RealField</span><span class="p">(</span><span class="mi">800</span><span class="p">)(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">arctan</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">findex</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ZZ</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">_sage_</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Gm</span><span class="o">.</span><span class="n">get_magma_attribute</span><span class="p">(</span><span class="s2">&quot;ShimGroupSidepairsIndex&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdargs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">_sage_</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Gm</span><span class="o">.</span><span class="n">get_magma_attribute</span><span class="p">(</span><span class="s2">&quot;ShimFDArgs&quot;</span><span class="p">)</span>
        <span class="p">]</span>  <span class="c1"># DEBUG - low precision</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">minus_one_long</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quaternion_rep</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">word_rep</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">temp_relation_words</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Um</span><span class="o">.</span><span class="n">Relations</span><span class="p">()[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LHS</span><span class="p">()</span><span class="o">.</span><span class="n">ElementToSequence</span><span class="p">()</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Um</span><span class="o">.</span><span class="n">Relations</span><span class="p">()))</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">temp_relation_words</span><span class="p">:</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="n">multiply_out</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="s2">&quot;P&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newrel</span> <span class="o">=</span> <span class="n">rel</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">minus_one</span>
                <span class="k">assert</span> <span class="n">multiply_out</span><span class="p">(</span><span class="n">newrel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newrel</span><span class="p">)</span>

        <span class="n">F1</span> <span class="o">=</span> <span class="n">FreeGroup</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Uside</span><span class="p">))])</span>
        <span class="n">G1</span> <span class="o">=</span> <span class="n">F1</span><span class="o">.</span><span class="n">quotient</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">F1</span><span class="p">(</span><span class="n">Um</span><span class="o">.</span><span class="n">Relations</span><span class="p">()[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LHS</span><span class="p">()</span><span class="o">.</span><span class="n">ElementToSequence</span><span class="p">()</span><span class="o">.</span><span class="n">_sage_</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Um</span><span class="o">.</span><span class="n">Relations</span><span class="p">()))</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">G2</span> <span class="o">=</span> <span class="n">FreeGroup</span><span class="p">(</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;y</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gens</span><span class="p">))]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">quotient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_G1</span> <span class="o">=</span> <span class="n">G1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_G2</span> <span class="o">=</span> <span class="n">G2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">translate</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magma_word_problem</span><span class="p">(</span><span class="n">Gm</span><span class="p">,</span> <span class="n">g</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">gquats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translate_inv</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="p">[</span><span class="o">-</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">trans</span><span class="p">)]</span> <span class="k">for</span> <span class="n">trans</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">]</span></div>



<div class="viewcode-block" id="ArithGroup_nf_kleinian">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_kleinian">[docs]</a>
<span class="k">class</span> <span class="nc">ArithGroup_nf_kleinian</span><span class="p">(</span><span class="n">ArithGroup_nf_generic</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_init_geometric_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Computing normalized basis (center = </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">center</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the following attributes:</span>
<span class="sd">        self._fundom_data</span>
<span class="sd">        self._RR</span>
<span class="sd">        self._vC</span>
<span class="sd">        self._HH</span>
<span class="sd">        self._center = self._HH(center)</span>
<span class="sd">        self._Pmat, self._Pmatinv</span>
<span class="sd">        self._simplification_iso</span>
<span class="sd">        self.Ugens</span>
<span class="sd">        self.F_units</span>
<span class="sd">        self.F_unit_offset</span>
<span class="sd">        self._relation_words</span>
<span class="sd">        self._gens</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">unit_group</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">+=</span> <span class="s2">&quot;_kleinian_</span><span class="si">{fielddisc}</span><span class="s2">_</span><span class="si">{quatalg}</span><span class="s2">_</span><span class="si">{levelnorm}</span><span class="s2">_</span><span class="si">{grouptype}</span><span class="s2">_</span><span class="si">{code}</span><span class="s2">.sobj&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">fielddisc</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">discriminant</span><span class="p">(),</span>
                <span class="n">quatalg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">discriminant</span><span class="p">()</span><span class="o">.</span><span class="n">norm</span><span class="p">(),</span>
                <span class="n">code</span><span class="o">=</span><span class="n">ZZ</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">(),</span>
                <span class="n">levelnorm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">norm</span><span class="p">(),</span>
                <span class="n">grouptype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">sage.misc.persist</span> <span class="kn">import</span> <span class="n">load</span>

                <span class="n">geom_dict</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ky</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">geom_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gens</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">element_class</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span> <span class="n">quaternion_rep</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">word_rep</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Initialized fundamental domain data from file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initialized fundamental domain data from file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Will save fundamental domain data to file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Will save fundamental domain data to file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="s2">&quot;GL&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span><span class="p">:</span>
            <span class="c1"># raise NotImplementedError(&#39;This implementation has bugs&#39;)</span>
            <span class="n">grouptype</span> <span class="o">=</span> <span class="s1">&#39;&quot;Units&quot;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grouptype</span> <span class="o">=</span> <span class="s1">&#39;&quot;NormOne&quot;&#39;</span>
            <span class="k">assert</span> <span class="s2">&quot;SL&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span>
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">QuaternionAlgebra</span><span class="p">(</span><span class="n">RealField</span><span class="p">(</span><span class="n">prec</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="n">QQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">QQ</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">QQ</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">magma_center</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">magma_center</span> <span class="o">=</span> <span class="n">H</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="n">periodenum</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;periodenum&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">enummethod</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enummethod&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;SmallBalls&quot;&#39;</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Seed = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;GetSeed()&quot;</span><span class="p">))</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot; O = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot; Basis = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span><span class="o">.</span><span class="n">Basis</span><span class="p">())</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot; ZBasis = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span><span class="o">.</span><span class="n">ZBasis</span><span class="p">())</span>
        <span class="n">verbose</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;grouptype = </span><span class="si">{</span><span class="n">grouptype</span><span class="si">}</span><span class="s2">, prec = </span><span class="si">{</span><span class="n">prec</span><span class="si">}</span><span class="s2">, periodenum = </span><span class="si">{</span><span class="n">periodenum</span><span class="si">}</span><span class="s2">, timeout = </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="n">verbose</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;magma_center = </span><span class="si">{</span><span class="n">magma_center</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># magma_level = sage_F_ideal_to_magma(self._F_magma, self.level)</span>
        <span class="c1"># verbose(f&#39;magma_level = {magma_level}&#39;)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span><span class="o">.</span><span class="n">NormalizedBasis</span><span class="p">(</span>
            <span class="n">GroupType</span><span class="o">=</span><span class="n">grouptype</span><span class="p">,</span>
            <span class="n">nvals</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">pr</span><span class="o">=</span><span class="n">prec</span><span class="p">,</span>
            <span class="n">pr_zetas</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">PeriodEnum</span><span class="o">=</span><span class="n">periodenum</span><span class="p">,</span>
            <span class="n">Center</span><span class="o">=</span><span class="n">magma_center</span><span class="p">,</span>
            <span class="n">max_time</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done normalizedbasis&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Timed out (</span><span class="si">%s</span><span class="s2"> sec) in NormalizedBasis&quot;</span> <span class="o">%</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="n">matlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">GetMatrixList</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Getting precision from Magma&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_RR</span> <span class="o">=</span> <span class="n">RR</span> <span class="o">=</span> <span class="n">RealField</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Radius</span><span class="p">))</span>
                    <span class="o">*</span> <span class="n">RealField</span><span class="p">(</span><span class="mi">20</span><span class="p">)(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
                    <span class="o">/</span> <span class="n">RealField</span><span class="p">(</span><span class="mi">20</span><span class="p">)(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">log</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">ceil</span><span class="p">()</span>
                <span class="o">-</span> <span class="mi">13</span>
            <span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_RR</span> <span class="o">=</span> <span class="n">RR</span> <span class="o">=</span> <span class="n">RealField</span><span class="p">(</span><span class="mi">800</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Getting precision done&quot;</span><span class="p">)</span>
        <span class="n">prec</span> <span class="o">=</span> <span class="n">RR</span><span class="o">.</span><span class="n">precision</span><span class="p">()</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="n">ComplexField</span><span class="p">(</span><span class="n">prec</span><span class="p">)</span>
        <span class="n">all_complex_embs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">embeddings</span><span class="p">(</span><span class="n">CC</span><span class="p">)</span> <span class="k">if</span> <span class="n">o</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">gen</span><span class="p">())</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_complex_embs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">vC</span> <span class="o">=</span> <span class="n">all_complex_embs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">InfinitePlaces</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="p">)[</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">signature</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">vC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">Im</span><span class="p">()</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span>
        <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vC</span> <span class="o">=</span> <span class="n">all_complex_embs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">vC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span>
                <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_F_magma</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">Im</span><span class="p">()</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span>
            <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vC</span> <span class="o">=</span> <span class="n">vC</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_HH</span> <span class="o">=</span> <span class="n">QuaternionAlgebra</span><span class="p">(</span><span class="n">RR</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HH</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HH</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Pmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Pmatinv</span> <span class="o">=</span> <span class="n">JtoP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HH</span><span class="p">,</span> <span class="n">MatrixSpace</span><span class="p">(</span><span class="n">CC</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
        <span class="n">centerlist</span> <span class="o">=</span> <span class="n">sage_eval</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">[i]`Center : i in [1..</span><span class="si">%s</span><span class="s2">]]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))),</span>
            <span class="p">{</span><span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">ih</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">:</span> <span class="n">jh</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">radiuslist</span> <span class="o">=</span> <span class="n">sage_eval</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">[i]`Radius : i in [1..</span><span class="si">%s</span><span class="s2">]]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
        <span class="p">)</span>
        <span class="n">matlist</span> <span class="o">=</span> <span class="n">sage_eval</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">[i] : i in [1..</span><span class="si">%s</span><span class="s2">]]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">matlist</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">))),</span>
            <span class="p">{</span><span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">ih</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">:</span> <span class="n">jh</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">kh</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fundom_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HH</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">RR</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">Matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HH</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">centerlist</span><span class="p">,</span> <span class="n">radiuslist</span><span class="p">,</span> <span class="n">matlist</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Computing presentation&quot;</span><span class="p">)</span>
        <span class="n">G</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">Presentation</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_O_magma</span><span class="p">,</span> <span class="n">nvals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hm</span><span class="p">,</span> <span class="n">GtoHm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">ReduceGenerators</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">nvals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">gen</span><span class="p">()</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
        <span class="n">chunk_length</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">ngens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gens</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">ngens</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">gens</span><span class="p">())</span>
        <span class="n">nchunks</span> <span class="o">=</span> <span class="p">(</span><span class="n">QQ</span><span class="p">(</span><span class="n">ngens</span><span class="p">)</span> <span class="o">/</span> <span class="n">QQ</span><span class="p">(</span><span class="n">chunk_length</span><span class="p">))</span><span class="o">.</span><span class="n">ceil</span><span class="p">()</span>
        <span class="n">verbose</span><span class="p">(</span>
            <span class="s2">&quot;Done ReduceGenerators. Now calculating inverse iso for </span><span class="si">%s</span><span class="s2"> generators&quot;</span>
            <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gens</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">tmp_quaternions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simplification_iso</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">):</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;... </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nchunks</span><span class="p">))</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">tt</span> <span class="o">*</span> <span class="n">chunk_length</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">tt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_length</span><span class="p">,</span> <span class="n">ngens</span><span class="p">)</span>
            <span class="n">newvec</span> <span class="o">=</span> <span class="n">sage_eval</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span>
                    <span class="s2">&quot;[ElementToSequence(Image(</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">.i)) : i in [</span><span class="si">%s</span><span class="s2">..</span><span class="si">%s</span><span class="s2">]]&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">GtoHm</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">G</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simplification_iso</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">newvec</span><span class="p">))</span>
            <span class="n">tmp_quaternions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">sage_eval</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span>
                        <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">[i] : i in [</span><span class="si">%s</span><span class="s2">..</span><span class="si">%s</span><span class="s2">]]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gens</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;$.1&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">),</span>
                    <span class="p">{</span><span class="s2">&quot;r&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simplification_iso</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fundom_data</span>
        <span class="p">),</span> <span class="s2">&quot;Simplification iso and facerels have different lengths (</span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_simplification_iso</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fundom_data</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span>
            <span class="s2">&quot;Done inverse isomorphism. Now calculating Ugens for </span><span class="si">%s</span><span class="s2"> generators&quot;</span>
            <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">Hm</span><span class="o">.</span><span class="n">gens</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wrds</span> <span class="o">=</span> <span class="n">sage_eval</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magma</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span>
                <span class="s2">&quot;[ElementToSequence(</span><span class="si">%s</span><span class="s2">!(</span><span class="si">%s</span><span class="s2">.i)) : i in [1..</span><span class="si">%s</span><span class="s2">]]&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">Hm</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Hm</span><span class="o">.</span><span class="n">gens</span><span class="p">()))</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">wd</span> <span class="ow">in</span> <span class="n">wrds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multiply_out</span><span class="p">(</span><span class="n">wd</span><span class="p">,</span> <span class="n">tmp_quaternions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">()))</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done calculating Ugens. Now initializing relations&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_unit_offset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;P&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">u</span><span class="p">))</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_units</span><span class="o">.</span><span class="n">gens</span><span class="p">()])</span>
            <span class="n">temp_relation_words</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Hm</span><span class="o">.</span><span class="n">Relations</span><span class="p">()[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LHS</span><span class="p">()</span><span class="o">.</span><span class="n">ElementToSequence</span><span class="p">()</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Hm</span><span class="o">.</span><span class="n">Relations</span><span class="p">()))</span>
            <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">F_unit_offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">multiplicative_order</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_units</span><span class="o">.</span><span class="n">gens</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">multiplicative_order</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Infinity</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="n">temp_relation_words</span><span class="p">:</span>
                <span class="n">remaining_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_units</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">(</span><span class="n">multiply_out</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">()))</span>
                <span class="p">)</span>
                <span class="k">assert</span> <span class="n">remaining_unit</span><span class="o">.</span><span class="n">multiplicative_order</span><span class="p">()</span> <span class="o">!=</span> <span class="n">Infinity</span>
                <span class="n">ulist</span> <span class="o">=</span> <span class="n">remaining_unit</span><span class="o">.</span><span class="n">exponents</span><span class="p">()</span>
                <span class="n">newrel</span> <span class="o">=</span> <span class="n">rel</span> <span class="o">+</span> <span class="n">syllables_to_tietze</span><span class="p">(</span>
                    <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_unit_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ulist</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">assert</span> <span class="n">multiply_out</span><span class="p">(</span><span class="n">newrel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newrel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Hm</span><span class="o">.</span><span class="n">Relations</span><span class="p">()[</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LHS</span><span class="p">()</span><span class="o">.</span><span class="n">ElementToSequence</span><span class="p">()</span><span class="o">.</span><span class="n">_sage_</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Hm</span><span class="o">.</span><span class="n">Relations</span><span class="p">()))</span>
            <span class="p">]</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done initializing relations. Now generators...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quaternion_rep</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">word_rep</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done initializing generators&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_fundom_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fundom_data</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_RR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RR</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_vC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vC</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_HH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HH</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_center</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_Pmat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Pmat</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_Pmatinv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Pmatinv</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_simplification_iso&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simplification_iso</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;Ugens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;F_unit_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F_unit_offset</span>
            <span class="n">ans</span><span class="p">[</span><span class="s2">&quot;_relation_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span>
            <span class="kn">from</span> <span class="nn">sage.misc.persist</span> <span class="kn">import</span> <span class="n">save</span>

            <span class="n">save</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Saved to file&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_kleinianmatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="n">K</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">base_ring</span><span class="p">()</span>
        <span class="n">CC</span> <span class="o">=</span> <span class="n">ComplexField</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_RR</span><span class="o">.</span><span class="n">precision</span><span class="p">())</span>
        <span class="n">vC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vC</span>
        <span class="n">aa</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="p">(</span><span class="n">vC</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">B</span><span class="o">.</span><span class="n">invariants</span><span class="p">())</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
        <span class="n">bsa</span> <span class="o">=</span> <span class="n">bb</span> <span class="o">*</span> <span class="n">sa</span>
        <span class="n">P</span><span class="p">,</span> <span class="n">Pinv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Pmat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Pmatinv</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span> <span class="o">=</span> <span class="p">(</span><span class="n">vC</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">gamma</span><span class="o">.</span><span class="n">coefficient_tuple</span><span class="p">())</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HH</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">hj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HH</span><span class="o">.</span><span class="n">gen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HH</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">real</span><span class="p">())</span> <span class="o">+</span> <span class="n">hi</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">imag</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Pinv</span>
            <span class="o">*</span> <span class="n">Matrix</span><span class="p">(</span>
                <span class="n">CC</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">sa</span><span class="p">,</span> <span class="n">x3</span> <span class="o">+</span> <span class="n">x4</span> <span class="o">*</span> <span class="n">sa</span><span class="p">,</span> <span class="n">x3</span> <span class="o">*</span> <span class="n">bb</span> <span class="o">-</span> <span class="n">x4</span> <span class="o">*</span> <span class="n">bsa</span><span class="p">,</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">sa</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="n">P</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">gamma</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">scal</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">m</span><span class="o">.</span><span class="n">determinant</span><span class="p">()</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
            <span class="n">m</span> <span class="o">*=</span> <span class="n">scal</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">apply_map</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span> <span class="o">*</span> <span class="n">hj</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span> <span class="o">*</span> <span class="n">hj</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span> <span class="o">*</span> <span class="n">hj</span>
        <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">conjugate</span><span class="p">())</span> <span class="o">*</span> <span class="n">hj</span>
        <span class="k">return</span> <span class="n">Matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_HH</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">])</span>

<div class="viewcode-block" id="ArithGroup_nf_kleinian.fundamental_domain">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_kleinian.fundamental_domain">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">fundamental_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="ArithGroup_nf_kleinian.get_word_rep">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_kleinian.get_word_rep">[docs]</a>
    <span class="k">def</span> <span class="nf">get_word_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>  <span class="c1"># nf_kleinian</span>
        <span class="n">HH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_HH</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">HH</span><span class="o">.</span><span class="n">base_ring</span><span class="p">()</span>
        <span class="n">boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fundom_data</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="o">-</span><span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="n">HH</span><span class="o">.</span><span class="n">base_ring</span><span class="p">()</span><span class="o">.</span><span class="n">precision</span><span class="p">())</span> <span class="o">/</span> <span class="n">R</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span>
        <span class="n">deltaword</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gammainv</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">**-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">correct</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">HH</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mat_gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kleinianmatrix</span><span class="p">(</span><span class="n">gammainv</span><span class="p">)</span>
            <span class="n">gammaz</span> <span class="o">=</span> <span class="n">act_H3</span><span class="p">(</span><span class="n">mat_gamma</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Empty boundary&quot;</span><span class="p">)</span>
            <span class="n">lengthw</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">i0</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">boundary</span><span class="p">):</span>
                    <span class="n">d1</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">sum</span><span class="p">(</span><span class="n">o</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="n">gammaz</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">coefficient_tuple</span><span class="p">())</span>
                        <span class="o">/</span> <span class="n">radius</span><span class="o">**</span><span class="mi">2</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">d1</span><span class="p">:</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">d1</span>
                        <span class="n">i0</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">break</span>  <span class="c1"># This might yield longer words, but should be faster!</span>
                <span class="k">if</span> <span class="n">i0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">gammaz</span> <span class="o">=</span> <span class="n">act_H3</span><span class="p">(</span><span class="n">boundary</span><span class="p">[</span><span class="n">i0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">gammaz</span><span class="p">)</span>
                <span class="n">deltaword</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">lengthw</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">correct</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">o</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">gammaz</span><span class="o">.</span><span class="n">coefficient_tuple</span><span class="p">()))</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">5.0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">correct</span><span class="p">:</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Error in word problem:&quot;</span><span class="p">)</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;gamma = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gamma</span><span class="p">)</span>
                <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;err = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="o">-</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">o</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">gammaz</span><span class="o">.</span><span class="n">coefficient_tuple</span><span class="p">())))</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error in word problem from Aurel 1&quot;</span><span class="p">)</span>
        <span class="n">deltaword</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_simplification_iso</span><span class="p">[</span><span class="n">o</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">deltaword</span><span class="p">),</span> <span class="p">[])</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Error in word problem from Aurel 2&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span></div>
</div>



<div class="viewcode-block" id="ArithGroup_nf_matrix_new">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix_new">[docs]</a>
<span class="k">class</span> <span class="nc">ArithGroup_nf_matrix_new</span><span class="p">(</span><span class="n">ArithGroup_nf_generic</span><span class="p">,</span> <span class="n">ArithGroup_matrix_generic</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base</span><span class="p">,</span>
        <span class="n">level</span><span class="p">,</span>
        <span class="n">level0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">info_magma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">grouptype</span><span class="o">=</span><span class="s2">&quot;PSL2&quot;</span><span class="p">,</span>
        <span class="n">magma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">compute_presentation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="n">level0</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Initializing small group...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">level0</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G0</span> <span class="o">=</span> <span class="n">ArithGroup_nf_matrix</span><span class="p">(</span>
            <span class="n">base</span><span class="p">,</span>
            <span class="n">base</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">base</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">level0</span><span class="p">,</span>
            <span class="n">grouptype</span><span class="o">=</span><span class="n">grouptype</span><span class="p">,</span>
            <span class="n">magma</span><span class="o">=</span><span class="n">magma</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">compute_presentation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_G0_gens_as_matrices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G0</span><span class="o">.</span><span class="n">quaternion_to_matrix</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">quaternion_rep</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">G0</span><span class="o">.</span><span class="n">gens</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done initializing small level group.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G0</span><span class="o">.</span><span class="n">B</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magma</span> <span class="o">=</span> <span class="n">magma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grouptype</span> <span class="o">=</span> <span class="n">grouptype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute generators of the subgroup Gamma_0(N), where N is the specified level.</span>

<span class="sd">        Write down representatives of the cosets</span>
<span class="sd">        for Gamma_0(N) in Gamma(1), which we identify with P^1(O_F/N). We already have</span>
<span class="sd">        code to compute with this: namely, cusp_reduction_table does precisely this.</span>

<span class="sd">        ALGORITHM :</span>

<span class="sd">        Retrieve the cusp reduction table. Recall that this is a dictionary with keys</span>
<span class="sd">        given by tuples (a,c) representing the element (a:c) in P^1(O_F/N). The entries</span>
<span class="sd">        are C, A, where c is the corresponding cusp (from cusp_set) and A is a matrix </span>
<span class="sd">        taking C to a matrix with bottom row (a:c).</span>
<span class="sd">        Generate the coset representatives: this is given by taking A*C as we range </span>
<span class="sd">        over all (A,C) in the values of cusp_reduction_table</span>
<span class="sd">        coset_reps is now a dictionary: keys are elements of P^1(O_F/N), and values are</span>
<span class="sd">        matrices which are coset reps for Gamma_0(N) in Gamma(1) cor. to these elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Computing coset reps...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coset_reps</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">set_immutable</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cusp_reduction_table</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done computing coset reps.&quot;</span><span class="p">)</span>
        <span class="c1">## compute the generators of H</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Computing the auxiliar data...&quot;</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gens_dict_auxiliary</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gens_matrices_auxiliary</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_gens_words_auxiliary</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generators_auxiliary</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gens_dict_auxiliary</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># DEBUG line</span>
            <span class="k">return</span>  <span class="c1"># DEBUG line</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done computing the auxiliary data.&quot;</span><span class="p">)</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Computing GAP information...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_gap_information</span><span class="p">()</span>
        <span class="n">verbose</span><span class="p">(</span><span class="s2">&quot;Done with GAP information...&quot;</span><span class="p">)</span>
        <span class="n">ArithGroup_nf_generic</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">base</span><span class="p">,</span>
            <span class="n">base</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">base</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">,</span>
            <span class="n">info_magma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">grouptype</span><span class="o">=</span><span class="n">grouptype</span><span class="p">,</span>
            <span class="n">magma</span><span class="o">=</span><span class="n">magma</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">compute_presentation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_repr_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Gamma0(</span><span class="si">%s</span><span class="s2">) over </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">)</span>

<div class="viewcode-block" id="ArithGroup_nf_matrix_new.matrix_to_quaternion">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix_new.matrix_to_quaternion">[docs]</a>
    <span class="k">def</span> <span class="nf">matrix_to_quaternion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">([(</span><span class="n">a</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span></div>


<div class="viewcode-block" id="ArithGroup_nf_matrix_new.quaternion_to_matrix">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix_new.quaternion_to_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">quaternion_to_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">quaternion_rep</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_basis</span><span class="p">())))</span>
        <span class="n">set_immutable</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ans</span></div>


<div class="viewcode-block" id="ArithGroup_nf_matrix_new.matrix_basis">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix_new.matrix_basis">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">matrix_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">MatrixSpace</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">M</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">M</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">M</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">M</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])]</span></div>


<div class="viewcode-block" id="ArithGroup_nf_matrix_new.get_word_rep">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix_new.get_word_rep">[docs]</a>
    <span class="k">def</span> <span class="nf">get_word_rep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  <span class="c1"># nf_matrix_new</span>
        <span class="n">wd_aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_word_rep_auxiliary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G0</span><span class="o">.</span><span class="n">quaternion_to_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">iso</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iso_mapping</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wd_aux</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">+=</span> <span class="n">iso</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">+=</span> <span class="p">[</span><span class="o">-</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">iso</span><span class="p">[</span><span class="o">-</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))]</span>
        <span class="k">return</span> <span class="n">ans</span></div>


    <span class="k">def</span> <span class="nf">_compute_gap_information</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gens</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">quaternion_rep</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">G0</span><span class="o">.</span><span class="n">gens</span><span class="p">()]</span>
        <span class="n">relation_words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G0</span><span class="o">.</span><span class="n">get_relation_words</span><span class="p">()</span>
        <span class="n">new_generators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gens_words_auxiliary</span>
        <span class="n">G1</span> <span class="o">=</span> <span class="n">FreeGroup</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gens</span><span class="p">))</span><span class="o">.</span><span class="n">quotient</span><span class="p">(</span><span class="n">relation_words</span><span class="p">)</span><span class="o">.</span><span class="n">gap</span><span class="p">()</span>
        <span class="n">G1gens</span> <span class="o">=</span> <span class="n">G1</span><span class="o">.</span><span class="n">GeneratorsOfGroup</span><span class="p">()</span>
        <span class="n">H1</span> <span class="o">=</span> <span class="n">G1</span><span class="o">.</span><span class="n">Subgroup</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">prod</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">G1gens</span><span class="p">[</span><span class="n">ZZ</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wd</span><span class="p">),</span>
                    <span class="n">G1gens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">wd</span> <span class="ow">in</span> <span class="n">new_generators</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">iso</span> <span class="o">=</span> <span class="n">H1</span><span class="o">.</span><span class="n">IsomorphismFpGroup</span><span class="p">()</span>
        <span class="n">H2</span> <span class="o">=</span> <span class="n">iso</span><span class="o">.</span><span class="n">Range</span><span class="p">()</span>
        <span class="n">H2gens</span> <span class="o">=</span> <span class="n">H2</span><span class="o">.</span><span class="n">GeneratorsOfGroup</span><span class="p">()</span>
        <span class="n">H2relators</span> <span class="o">=</span> <span class="n">H2</span><span class="o">.</span><span class="n">RelatorsOfFpGroup</span><span class="p">()</span>
        <span class="c1"># Parse generators of H2 into Sage</span>
        <span class="n">H2genlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">H2gens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_final_gens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">H2gens</span><span class="p">):</span>
            <span class="n">update_progress</span><span class="p">(</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">H2genlen</span><span class="p">),</span> <span class="s2">&quot;Parsing generators of H2&quot;</span>
            <span class="p">)</span>
            <span class="n">wd</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">iso</span><span class="o">.</span><span class="n">PreImagesRepresentative</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="o">.</span><span class="n">UnderlyingElement</span><span class="p">()</span>
                <span class="o">.</span><span class="n">LetterRepAssocWord</span><span class="p">()</span>
                <span class="o">.</span><span class="n">sage</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_final_gens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prod</span><span class="p">(</span><span class="n">gens</span><span class="p">[</span><span class="n">ZZ</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">wd</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gens</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quaternion_rep</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">word_rep</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Ugens</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">H2relatorlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">H2relators</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">H2relatorlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Parse relators</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">wd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">H2relators</span><span class="p">):</span>
                <span class="n">update_progress</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">H2relatorlen</span><span class="p">),</span> <span class="s2">&quot;Parsing relators for H2&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_relation_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">wd</span><span class="o">.</span><span class="n">UnderlyingElement</span><span class="p">()</span><span class="o">.</span><span class="n">LetterRepAssocWord</span><span class="p">()</span><span class="o">.</span><span class="n">sage</span><span class="p">()</span>
                <span class="p">)</span>

        <span class="c1"># Calculate final_gens as matrices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iso_mapping</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">H1gens</span> <span class="o">=</span> <span class="n">H1</span><span class="o">.</span><span class="n">GeneratorsOfGroup</span><span class="p">()</span>
        <span class="n">H1genlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">H1gens</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">H1gens</span><span class="p">):</span>
            <span class="n">update_progress</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">H1genlen</span><span class="p">),</span> <span class="s2">&quot;Parsing isomorphism&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_iso_mapping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">iso</span><span class="o">.</span><span class="n">ImageElm</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">UnderlyingElement</span><span class="p">()</span><span class="o">.</span><span class="n">LetterRepAssocWord</span><span class="p">()</span><span class="o">.</span><span class="n">sage</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_represent_in_coset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        g is an element of Gamma(1). Represent it as h * p, where h in Gamma_0 and p is a rep.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## We can read off the class from the bottom row, computing in P(O_F/N)</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_P1List</span><span class="p">()</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">N</span><span class="p">()</span>
        <span class="n">coset_class</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">==</span> <span class="n">QQ</span> <span class="k">else</span> <span class="n">P</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">tuple</span><span class="p">()</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coset_reps</span><span class="p">[</span><span class="n">coset_class</span><span class="p">]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="n">rep</span><span class="o">.</span><span class="n">adjugate</span><span class="p">()</span>
        <span class="n">set_immutable</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="c1">## Now check that h really is in Gamma_0(N)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">==</span> <span class="n">QQ</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">N</span>
        <span class="k">return</span> <span class="n">h</span><span class="p">,</span> <span class="n">rep</span>

    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">_generators_auxiliary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute generators for Gamma_0(N) via its right coset representatives in Gamma(1).</span>

<span class="sd">        OUTPUT:</span>
<span class="sd">            - small_gens_matrices, a dictionary: the keys are matrices A,</span>
<span class="sd">                which are generators of the small group, and the values are integers;</span>

<span class="sd">            - small_gens_words, a list: the D[A]-th entry is the matrix A written</span>
<span class="sd">                as a word in the generators of Gamma(1).</span>

<span class="sd">        The words are written in Tietze form, i.e. [1,2,1,-2,-1,2] corr. to</span>
<span class="sd">        g * h * g * h^(-1) * g^(-1) * h, where g,h = (ordered) gens of Gamma(1).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">g0gens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G0_gens_as_matrices</span>
        <span class="n">small_gens_matrices_dict</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{}</span>
        <span class="p">)</span>  <span class="c1">## This will contain the output: matrix form, dictionary with keys the matrices</span>
        <span class="n">small_gens_matrices</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">## list of the matrices in order</span>
        <span class="n">small_gens_words</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">## This will contain the output: word form.</span>
        <span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">## Loop over all gens of big group</span>
        <span class="n">total_iterations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">g0gens</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coset_reps</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">g0gens</span> <span class="o">+</span> <span class="p">[</span><span class="o">~</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">g0gens</span><span class="p">]:</span>
            <span class="c1">## Loop over all coset reps</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coset_reps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1">## compute p*g, represent as h * p_prime for h in subgroup</span>
                <span class="n">h</span><span class="p">,</span> <span class="n">p_prime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_represent_in_coset</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">g</span><span class="p">)</span>
                <span class="c1">## check h is not 1 and not repeating gens or their inverses</span>
                <span class="n">hinv</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">adjugate</span><span class="p">()</span>
                <span class="n">set_immutable</span><span class="p">(</span><span class="n">hinv</span><span class="p">)</span>
                <span class="n">set_immutable</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">update_progress</span><span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_iterations</span><span class="p">),</span>
                    <span class="s2">&quot;Computing auxiliary generators&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">h</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">small_gens_matrices_dict</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">hinv</span> <span class="ow">in</span> <span class="n">small_gens_matrices_dict</span>
                <span class="p">):</span>
                    <span class="c1">## This is new. Add h to the dictionary and add one to the index for next time</span>
                    <span class="n">small_gens_matrices_dict</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">current_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1">## also add h to the list of matrices</span>
                    <span class="n">small_gens_matrices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                    <span class="c1">## Now solve the word problem</span>
                    <span class="n">word</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G0</span><span class="o">.</span><span class="n">get_word_rep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G0</span><span class="o">.</span><span class="n">matrix_to_quaternion</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>
                    <span class="n">small_gens_words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">small_gens_matrices_dict</span><span class="p">,</span> <span class="n">small_gens_matrices</span><span class="p">,</span> <span class="n">small_gens_words</span>

    <span class="k">def</span> <span class="nf">_get_word_rep_auxiliary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solve the word problem in the small group Gamma_0(N) in the list of generators output</span>
<span class="sd">        by _generators_auxiliary.</span>

<span class="sd">        Firstly, we write this as h = 1.h. Then we write h = gh&#39;, where g in Gens(G) (so we must be</span>
<span class="sd">        able to solve the word problem for G). Then write 1.g = zp&#39;, so that</span>
<span class="sd">            h = z * p&#39; * h&#39;. Now iterate. We will end up with z_1 z_2 ... z_t p_0, where p_0 = id rep.</span>

<span class="sd">        OUTPUT:</span>

<span class="sd">        - a list of integers in {-t,-t+1,...,t-1,t}, where the output of _generators_auxiliary is</span>
<span class="sd">          [a_1,...,a_t].</span>

<span class="sd">        For example,</span>

<span class="sd">           h = abc in H, a,b,c in Gens(G)</span>
<span class="sd">           h = 1.abc</span>
<span class="sd">             = 1ap^(-1) . pbc</span>
<span class="sd">             = 1ap^(-1) . pbq^(-1) . qc</span>
<span class="sd">             = 1ap^(-1) . pbq^(-1) . qc1^(-1)</span>
<span class="sd">             = z1 . z2 . z3, where each zi is in the generating set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gens_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_G0_gens_as_matrices</span>

        <span class="c1">## Initialise final output</span>
        <span class="n">h_level_N_wp</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">## Write h in the generators of g</span>
        <span class="n">h_level0_wp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G0</span><span class="o">.</span><span class="n">get_word_rep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G0</span><span class="o">.</span><span class="n">matrix_to_quaternion</span><span class="p">(</span><span class="n">h</span><span class="p">))</span>

        <span class="c1">## We start with p_0 = id representative</span>
        <span class="n">current_p</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">set_immutable</span><span class="p">(</span><span class="n">current_p</span><span class="p">)</span>

        <span class="c1">## loop through every generator that appears in the word of h (in G)</span>
        <span class="k">for</span> <span class="n">gen_ind</span> <span class="ow">in</span> <span class="n">h_level0_wp</span><span class="p">:</span>
            <span class="c1">## Compute the generator we&#39;re processing</span>
            <span class="n">current_gen</span> <span class="o">=</span> <span class="n">gens_G</span><span class="p">[</span><span class="n">ZZ</span><span class="p">(</span><span class="n">gen_ind</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ZZ</span><span class="p">(</span><span class="n">gen_ind</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">current_gen</span> <span class="o">=</span> <span class="n">current_gen</span><span class="o">.</span><span class="n">adjugate</span><span class="p">()</span>
            <span class="c1">## Compute the generator and update p_i to p_{i+1}</span>
            <span class="n">h_current</span><span class="p">,</span> <span class="n">current_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_represent_in_coset</span><span class="p">(</span><span class="n">current_p</span> <span class="o">*</span> <span class="n">current_gen</span><span class="p">)</span>
            <span class="c1">## h_current should be one of our generators! As it is of form p&#39;gp^(-1)</span>
            <span class="k">if</span> <span class="n">h_current</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1">## check not identity</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">gen_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gens_dict_auxiliary</span><span class="p">[</span><span class="n">h_current</span><span class="p">]</span>
                    <span class="c1">## Great, we&#39;ve found a generator. Let&#39;s move on</span>
                    <span class="c1">## Compute the index corresponding to this generator</span>
                    <span class="c1">## The generator appearing is not inverse. So append the index</span>
                    <span class="n">h_level_N_wp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1">## h_current^(-1) should be in the dictionary</span>
                    <span class="n">h_curr_inv</span> <span class="o">=</span> <span class="n">h_current</span><span class="o">.</span><span class="n">adjugate</span><span class="p">()</span>
                    <span class="n">set_immutable</span><span class="p">(</span><span class="n">h_curr_inv</span><span class="p">)</span>
                    <span class="c1">## Great, we&#39;ve found a generator. Let&#39;s move on</span>
                    <span class="c1">## Compute the index corresponding to this generator</span>
                    <span class="n">gen_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gens_dict_auxiliary</span><span class="p">[</span><span class="n">h_curr_inv</span><span class="p">]</span>
                    <span class="c1">## The generator appearing is an inverse. So append negative the index</span>
                    <span class="n">h_level_N_wp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">gen_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1">## Check that we have actually solved the word problem correctly</span>
        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="n">check_h</span> <span class="o">=</span> <span class="n">prod</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_gens_matrices_auxiliary</span><span class="p">[</span><span class="n">ZZ</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="p">(</span><span class="n">ZZ</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">h_level_N_wp</span>
            <span class="p">)</span>
            <span class="k">assert</span> <span class="n">check_h</span> <span class="o">==</span> <span class="n">h</span>
        <span class="k">return</span> <span class="n">h_level_N_wp</span></div>



<div class="viewcode-block" id="ArithGroup_nf_matrix">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix">[docs]</a>
<span class="k">class</span> <span class="nc">ArithGroup_nf_matrix</span><span class="p">(</span><span class="n">ArithGroup_nf_kleinian</span><span class="p">,</span> <span class="n">ArithGroup_matrix_generic</span><span class="p">):</span>
<div class="viewcode-block" id="ArithGroup_nf_matrix.matrix_to_quaternion">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix.matrix_to_quaternion">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">matrix_to_quaternion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">([(</span><span class="n">a</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">])</span></div>


<div class="viewcode-block" id="ArithGroup_nf_matrix.quaternion_to_matrix">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix.quaternion_to_matrix">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">quaternion_to_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">quaternion_rep</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_basis</span><span class="p">())))</span>
        <span class="n">set_immutable</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ans</span></div>


<div class="viewcode-block" id="ArithGroup_nf_matrix.matrix_basis">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix.matrix_basis">[docs]</a>
    <span class="nd">@cached_method</span>
    <span class="k">def</span> <span class="nf">matrix_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">MatrixSpace</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">M</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">M</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">M</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">M</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])]</span></div>


<div class="viewcode-block" id="ArithGroup_nf_matrix.element_of_norm">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix.element_of_norm">[docs]</a>
    <span class="nd">@cached_method</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">use_magma</span><span class="p">,</span> <span class="n">return_all</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">max_elements</span><span class="p">:</span> <span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">N</span><span class="p">,</span>
            <span class="n">return_all</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">def</span> <span class="nf">element_of_norm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">use_magma</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_elements</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>  <span class="c1"># in nf_matrix</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_to_quaternion</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">candidate</span><span class="o">.</span><span class="n">reduced_norm</span><span class="p">()</span> <span class="o">==</span> <span class="n">N</span>
        <span class="n">set_immutable</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_all</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">candidate</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">candidate</span></div>


<div class="viewcode-block" id="ArithGroup_nf_matrix.non_positive_unit">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix.non_positive_unit">[docs]</a>
    <span class="k">def</span> <span class="nf">non_positive_unit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_to_quaternion</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span></div>


<div class="viewcode-block" id="ArithGroup_nf_matrix.generate_wp_candidates">
<a class="viewcode-back" href="../../arithmeticgroups.html#darmonpoints.arithgroup.ArithGroup_nf_matrix.generate_wp_candidates">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_wp_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ideal_p</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># In ArithGroup_nf_matrix</span>
        <span class="n">initial_wp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;initial_wp&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ideal_p</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ideal_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix_to_quaternion</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Follow Atkin--Li # DEBUG!!!</span>
            <span class="k">if</span> <span class="n">initial_wp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">ideal_p</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">.</span><span class="n">gens_reduced</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ideal_m</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">ideal</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ideal_m</span><span class="o">.</span><span class="n">residues</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">ideal_m</span><span class="p">)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="n">m</span>
                <span class="n">ans</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">z</span><span class="p">,</span> <span class="n">p</span> <span class="o">*</span> <span class="n">w</span><span class="p">])</span>
                <span class="k">assert</span> <span class="n">ans</span><span class="o">.</span><span class="n">determinant</span><span class="p">()</span> <span class="o">==</span> <span class="n">p</span>
                <span class="n">all_initial</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix_to_quaternion</span><span class="p">(</span><span class="n">ans</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_initial</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix_to_quaternion</span><span class="p">(</span><span class="n">initial_wp</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">cantor_diagonal</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_elements</span><span class="p">(</span><span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">enumerate_elements</span><span class="p">(</span><span class="n">random</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">all_initial</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">v1</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">v2</span></div>
</div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2016-2024, Marc Masdeu
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=efe5be6f"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>